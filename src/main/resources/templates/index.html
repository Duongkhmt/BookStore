<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Trang ch·ªß - BookStore</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style th:fragment="style">
        /* === VARIABLES === */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-light: #f8fafc;
            --white: #ffffff;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* === HEADER NAVIGATION === */
        .header-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 1rem 2rem;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            font-size: 1.8rem;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn-nav {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .btn-nav-login {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .btn-nav-login:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .btn-nav-register {
            background: var(--primary);
            color: var(--white);
        }

        .btn-nav-register:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            background: var(--primary-dark);
        }

        /* === HERO SECTION === */
        .hero-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            position: relative;
            overflow: hidden;
            padding: 6rem 1.5rem 4rem;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" opacity="0.1"><polygon fill="white" points="0,1000 1000,0 1000,1000"/></svg>');
            background-size: cover;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 800px;
            color: var(--white);
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            line-height: 1.1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero-subtitle {
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
            opacity: 0.95;
            line-height: 1.6;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-hero {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-hero-primary {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        .btn-hero-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            background: var(--bg-light);
        }

        .btn-hero-outline {
            border: 2px solid var(--white);
            color: var(--white);
            background: transparent;
        }

        .btn-hero-outline:hover {
            background: var(--white);
            color: var(--primary);
            transform: translateY(-3px);
        }

        /* === MAP SECTION === */
        .map-section {
            padding: 6rem 1.5rem;
            background: var(--white);
        }

        .map-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            max-width: 1200px;
            margin: 0 auto;
            align-items: start;
        }

        .map-content {
            padding-right: 2rem;
        }

        .map-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .map-subtitle {
            font-size: 1.125rem;
            color: var(--text-light);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .map-features {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .map-feature {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .map-feature:hover {
            transform: translateX(10px);
            background: var(--primary);
            color: var(--white);
        }

        .map-feature-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
            border-radius: 50%;
            box-shadow: var(--shadow);
        }

        .map-feature-text {
            font-weight: 500;
        }

        #map {
            height: 500px;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid #e2e8f0;
        }

        .location-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-location {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-location-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-location-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-location-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-location-outline:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
        }

        .location-info {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
        }

        .location-text {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 0;
        }

        /* === FEATURES SECTION === */
        .features-section {
            padding: 6rem 1.5rem;
            background: var(--bg-light);
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .section-subtitle {
            text-align: center;
            font-size: 1.125rem;
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto 4rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: var(--white);
            padding: 3rem 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            display: block;
        }

        .feature-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .feature-text {
            color: var(--text-light);
            line-height: 1.6;
        }

        /* === STATS SECTION === */
        .stats-section {
            padding: 6rem 1.5rem;
            background: var(--white);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1.125rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* === CTA SECTION === */
        .cta-section {
            padding: 6rem 1.5rem;
            background: var(--gradient-primary);
            color: var(--white);
            text-align: center;
        }

        .cta-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .cta-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .cta-text {
            font-size: 1.125rem;
            margin-bottom: 2.5rem;
            opacity: 0.95;
        }

        .btn-cta {
            background: var(--white);
            color: var(--primary);
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-cta:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 968px) {
            .map-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .map-content {
                padding-right: 0;
            }

            #map {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }

            .hero-actions {
                flex-direction: column;
                align-items: center;
            }

            .btn-hero {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }

            .section-title {
                font-size: 2rem;
            }

            .map-title {
                font-size: 2rem;
            }

            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            .header-nav {
                padding: 1rem;
            }
        }

        /* === ANIMATIONS === */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }
        /* Map Section v·ªõi Leaflet */
        #map {
            height: 500px;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid #e2e8f0;
            z-index: 1;
        }

        /* Leaflet custom styles */
        .leaflet-container {
            background: #f8fafc;
            font-family: inherit;
        }

        .custom-marker {
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .bookstore-marker {
            background: var(--accent);
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .location-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #dc2626;
        }

        .location-success {
            background: #dcfce7;
            border-left: 4px solid #22c55e;
            color: #15803d;
        }

        .feature-card:nth-child(1) { transition-delay: 0.1s; }
        .feature-card:nth-child(2) { transition-delay: 0.2s; }
        .feature-card:nth-child(3) { transition-delay: 0.3s; }
    </style>
</head>

<body>
<div layout:fragment="content">
    <!-- Header Navigation -->
    <header class="header-nav">
        <div class="nav-container">
            <a href="#" class="logo">
                <span class="logo-icon">üìö</span>
                <span>BookStore</span>
            </a>
            <div class="auth-buttons">
                <a th:href="@{/login}" class="btn-nav btn-nav-login">ƒêƒÉng nh·∫≠p</a>
                <a th:href="@{/register}" class="btn-nav btn-nav-register">ƒêƒÉng k√Ω</a>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title floating">
                üìö Th·∫ø Gi·ªõi S√°ch <br>Trong T·∫ßm Tay B·∫°n
            </h1>
            <p class="hero-subtitle">
                Kh√°m ph√° h√†ng ng√†n ƒë·∫ßu s√°ch thu·ªôc m·ªçi th·ªÉ lo·∫°i. ƒê·ªçc, h·ªçc h·ªèi,
                v√† ph√°t tri·ªÉn m·ªói ng√†y v·ªõi th∆∞ vi·ªán s√°ch phong ph√∫ nh·∫•t.
            </p>
            <div class="hero-actions">
                <a th:href="@{/catalog}" class="btn-hero btn-hero-primary">
                    üöÄ Kh√°m ph√° Ngay
                </a>
                <a href="#map-section" class="btn-hero btn-hero-outline">
                    üó∫Ô∏è T√¨m C·ª≠a H√†ng G·∫ßn B·∫°n
                </a>
            </div>
        </div>
    </section>

    <!-- Map Section -->
    <section class="map-section" id="map-section">
        <div class="map-container">
            <div class="map-content">
                <h2 class="map-title">üìç T√¨m C·ª≠a H√†ng S√°ch G·∫ßn B·∫°n</h2>
                <p class="map-subtitle">
                    Kh√°m ph√° c√°c nh√† s√°ch, th∆∞ vi·ªán v√† c·ª≠a h√†ng s√°ch g·∫ßn v·ªã tr√≠ c·ªßa b·∫°n.
                    Ch√∫ng t√¥i s·∫Ω gi√∫p b·∫°n t√¨m th·∫•y nh·ªØng ƒë·ªãa ƒëi·ªÉm y√™u th√≠ch nh·∫•t.
                </p>

                <div class="map-features">
                    <div class="map-feature">
                        <div class="map-feature-icon">üìç</div>
                        <div class="map-feature-text">X√°c ƒë·ªãnh v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n</div>
                    </div>
                    <div class="map-feature">
                        <div class="map-feature-icon">üè™</div>
                        <div class="map-feature-text">T√¨m c·ª≠a h√†ng s√°ch g·∫ßn nh·∫•t</div>
                    </div>
                    <div class="map-feature">
                        <div class="map-feature-icon">üõ£Ô∏è</div>
                        <div class="map-feature-text">Ch·ªâ ƒë∆∞·ªùng chi ti·∫øt</div>
                    </div>
                    <div class="map-feature">
                        <div class="map-feature-icon">‚≠ê</div>
                        <div class="map-feature-text">ƒê√°nh gi√° v√† nh·∫≠n x√©t t·ª´ ƒë·ªôc gi·∫£</div>
                    </div>
                </div>

                <div class="location-controls">
                    <button class="btn-location btn-location-primary" onclick="getCurrentLocation()">
                        üìç L·∫•y V·ªã Tr√≠ C·ªßa T√¥i
                    </button>
                    <button class="btn-location btn-location-outline" onclick="findBookstores()">
                        üè™ T√¨m Nh√† S√°ch G·∫ßn ƒê√¢y
                    </button>
                    <button class="btn-location btn-location-outline" onclick="useDefaultLocation()">
                        üéØ S·ª≠ d·ª•ng V·ªã tr√≠ M·∫∑c ƒë·ªãnh
                    </button>
                </div>

                <div class="location-info" id="locationInfo" style="display: none;">
                    <p class="location-text" id="locationText">ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...</p>
                </div>

                <!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
                <div class="location-info location-success" style="margin-top: 1rem;">
                    <p class="location-text">
                        <strong>üí° L∆∞u √Ω:</strong> ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng ƒë·ªãnh v·ªã, h√£y:<br>
                        1. Cho ph√©p tr√¨nh duy·ªát truy c·∫≠p v·ªã tr√≠ c·ªßa b·∫°n<br>
                        2. Ho·∫∑c s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh (H√† N·ªôi)
                    </p>
                </div>
            </div>

            <div id="map"></div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section" id="features">
        <h2 class="section-title">T·∫°i sao ch·ªçn BookStore?</h2>
        <p class="section-subtitle">
            Tr·∫£i nghi·ªám mua s√°ch tr·ª±c tuy·∫øn t·ªët nh·∫•t v·ªõi nh·ªØng ∆∞u ƒëi·ªÉm v∆∞·ª£t tr·ªôi
        </p>

        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">üìö</div>
                <h3 class="feature-title">Th∆∞ Vi·ªán ƒêa D·∫°ng</h3>
                <p class="feature-text">
                    H∆°n 10,000+ ƒë·∫ßu s√°ch thu·ªôc m·ªçi th·ªÉ lo·∫°i t·ª´ kinh t·∫ø, vƒÉn h·ªçc,
                    khoa h·ªçc ƒë·∫øn s√°ch thi·∫øu nhi v√† gi√°o tr√¨nh.
                </p>
            </div>

            <div class="feature-card">
                <div class="feature-icon">üöÄ</div>
                <h3 class="feature-title">Giao H√†ng Si√™u T·ªëc</h3>
                <p class="feature-text">
                    Giao h√†ng to√†n qu·ªëc trong 2-4 gi·ªù t·∫°i n·ªôi th√†nh. Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn
                    cho ƒë∆°n h√†ng t·ª´ 199K.
                </p>
            </div>

            <div class="feature-card">
                <div class="feature-icon">üéØ</div>
                <h3 class="feature-title">∆Øu ƒê√£i ƒê·∫∑c Bi·ªát</h3>
                <p class="feature-text">
                    Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho th√†nh vi√™n m·ªõi. T√≠ch ƒëi·ªÉm ƒë·ªïi qu√†
                    v√† nhi·ªÅu ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i h·∫•p d·∫´n.
                </p>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">10,000+</div>
                <div class="stat-label">ƒê·∫ßu S√°ch</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">50,000+</div>
                <div class="stat-label">ƒê·ªôc Gi·∫£</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">99%</div>
                <div class="stat-label">H√†i L√≤ng</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">24/7</div>
                <div class="stat-label">H·ªó Tr·ª£</div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
        <div class="cta-content">
            <h2 class="cta-title">S·∫µn s√†ng kh√°m ph√° th·∫ø gi·ªõi s√°ch?</h2>
            <p class="cta-text">
                ƒêƒÉng k√Ω ngay h√¥m nay ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i ƒë·∫∑c bi·ªát v√† tr·∫£i nghi·ªám
                th·∫ø gi·ªõi s√°ch tuy·ªát v·ªùi c·ªßa ch√∫ng t√¥i.
            </p>
            <a th:href="@{/register}" class="btn-cta">
                üéÅ ƒêƒÉng k√Ω Ngay - Nh·∫≠n ∆Øu ƒê√£i
            </a>
        </div>
    </section>
</div>

<!-- Script -->
<th:block layout:fragment="script">
    <script>
        let map;
        let userMarker;
        let currentLocation = null;
        let bookstores = [];
        let bookstoreLayer;

        // Kh·ªüi t·∫°o map v·ªõi Leaflet
        function initMap() {
            // V·ªã tr√≠ m·∫∑c ƒë·ªãnh (H√† N·ªôi)
            const defaultLocation = [21.0278, 105.8342];

            map = L.map('map').setView(defaultLocation, 12);

            // S·ª≠ d·ª•ng OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);

            // T·∫°o layer group cho c√°c nh√† s√°ch
            bookstoreLayer = L.layerGroup().addTo(map);

            console.log('üó∫Ô∏è Leaflet Map ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o v·ªõi OpenStreetMap');

            // T·ª± ƒë·ªông th·ª≠ l·∫•y v·ªã tr√≠ khi trang load
            setTimeout(() => {
                checkGeolocationSupport();
            }, 1000);
        }

        // Ki·ªÉm tra h·ªó tr·ª£ geolocation
        function checkGeolocationSupport() {
            if (!navigator.geolocation) {
                updateLocationInfo('‚ùå Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Geolocation', 'error');
                return false;
            }
            return true;
        }

        // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
        function getCurrentLocation() {
            if (!checkGeolocationSupport()) return;

            updateLocationInfo('üîÑ ƒêang x√°c ƒë·ªãnh v·ªã tr√≠ c·ªßa b·∫°n...', 'loading');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                // Success callback
                (position) => {
                    const pos = [position.coords.latitude, position.coords.longitude];
                    currentLocation = pos;

                    // Di chuy·ªÉn map ƒë·∫øn v·ªã tr√≠ hi·ªán t·∫°i
                    map.setView(pos, 15);

                    // Th√™m marker cho v·ªã tr√≠ hi·ªán t·∫°i
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    userMarker = L.marker(pos, {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            iconSize: [20, 20]
                        })
                    }).addTo(map)
                        .bindPopup('üìç <strong>V·ªã tr√≠ c·ªßa b·∫°n</strong>')
                        .openPopup();

                    // Hi·ªÉn th·ªã th√¥ng tin v·ªã tr√≠
                    getAddressFromCoordinates(pos[0], pos[1]);

                    console.log('üìç V·ªã tr√≠ ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh:', pos);
                },
                // Error callback
                (error) => {
                    console.error('‚ùå L·ªói l·∫•y v·ªã tr√≠:', error);
                    handleLocationError(error);
                },
                options
            );
        }

        // S·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh (H√† N·ªôi)
        function useDefaultLocation() {
            const defaultLocation = [21.0278, 105.8342];
            currentLocation = defaultLocation;

            // Di chuy·ªÉn map ƒë·∫øn v·ªã tr√≠ m·∫∑c ƒë·ªãnh
            map.setView(defaultLocation, 13);

            // Th√™m marker cho v·ªã tr√≠ m·∫∑c ƒë·ªãnh
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            userMarker = L.marker(defaultLocation, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    iconSize: [20, 20]
                })
            }).addTo(map)
                .bindPopup('üìç <strong>V·ªã tr√≠ m·∫∑c ƒë·ªãnh (H√† N·ªôi)</strong><br>Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø c·ªßa b·∫°n')
                .openPopup();

            updateLocationInfo('üìç ƒêang s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh: H√† N·ªôi', 'success');

            // T·ª± ƒë·ªông t√¨m nh√† s√°ch quanh v·ªã tr√≠ m·∫∑c ƒë·ªãnh
            setTimeout(() => {
                findBookstores();
            }, 1000);
        }

        // C·∫≠p nh·∫≠t th√¥ng b√°o v·ªã tr√≠
        function updateLocationInfo(message, type = 'info') {
            const locationInfo = document.getElementById('locationInfo');
            const locationText = document.getElementById('locationText');

            locationInfo.style.display = 'block';
            locationText.textContent = message;

            // Reset classes
            locationInfo.className = 'location-info';

            // Th√™m class theo type
            if (type === 'error') {
                locationInfo.classList.add('location-error');
            } else if (type === 'success') {
                locationInfo.classList.add('location-success');
            }
        }

        // L·∫•y ƒë·ªãa ch·ªâ t·ª´ t·ªça ƒë·ªô (s·ª≠ d·ª•ng Nominatim - free)
        function getAddressFromCoordinates(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        // Gi·ªõi h·∫°n ƒë·ªô d√†i ƒë·ªãa ch·ªâ
                        const address = data.display_name.length > 100
                            ? data.display_name.substring(0, 100) + '...'
                            : data.display_name;
                        updateLocationInfo(`üìç V·ªã tr√≠ c·ªßa b·∫°n: ${address}`, 'success');
                    } else {
                        updateLocationInfo(`üìç V·ªã tr√≠: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi l·∫•y ƒë·ªãa ch·ªâ:', error);
                    updateLocationInfo(`üìç V·ªã tr√≠: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
                });
        }

        // X·ª≠ l√Ω l·ªói location
        function handleLocationError(error) {
            let errorMessage = '‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh khi l·∫•y v·ªã tr√≠';

            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi cho ph√©p truy c·∫≠p v·ªã tr√≠. Vui l√≤ng c·∫•p quy·ªÅn trong tr√¨nh duy·ªát ho·∫∑c s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '‚ùå Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh.';
                    break;
                case error.TIMEOUT:
                    errorMessage = '‚ùå H·∫øt th·ªùi gian ch·ªù x√°c ƒë·ªãnh v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i.';
                    break;
            }

            updateLocationInfo(errorMessage, 'error');

            // T·ª± ƒë·ªông ƒë·ªÅ xu·∫•t s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh sau 3 gi√¢y
            setTimeout(() => {
                if (!currentLocation) {
                    updateLocationInfo('üí° ƒêang s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh (H√† N·ªôi)...', 'info');
                    setTimeout(() => {
                        useDefaultLocation();
                    }, 1000);
                }
            }, 3000);
        }

        // T√¨m nh√† s√°ch g·∫ßn ƒë√¢y
        function findBookstores() {
            if (!currentLocation) {
                updateLocationInfo('üìç Vui l√≤ng l·∫•y v·ªã tr√≠ c·ªßa b·∫°n tr∆∞·ªõc ho·∫∑c s·ª≠ d·ª•ng v·ªã tr√≠ m·∫∑c ƒë·ªãnh!', 'error');
                return;
            }

            updateLocationInfo('üîç ƒêang t√¨m nh√† s√°ch v√† th∆∞ vi·ªán g·∫ßn ƒë√¢y...', 'loading');

            // D·ªØ li·ªáu nh√† s√°ch m·∫´u cho H√† N·ªôi
            const hanoiBookstores = [
                {
                    name: "Nh√† s√°ch Tr√≠ Tu·ªá",
                    lat: 21.0245,
                    lng: 105.8417,
                    address: "52 L√™ Thanh Ngh·ªã, Hai B√† Tr∆∞ng",
                    type: "bookstore",
                    rating: 4.2
                },
                {
                    name: "Nh√† s√°ch Fahasa",
                    lat: 21.0304,
                    lng: 105.8521,
                    address: "341 Tr∆∞·ªùng Chinh, Thanh Xu√¢n",
                    type: "bookstore",
                    rating: 4.5
                },
                {
                    name: "Nh√† s√°ch Kim ƒê·ªìng",
                    lat: 21.0192,
                    lng: 105.8349,
                    address: "55 Quang Trung, Ho√†n Ki·∫øm",
                    type: "bookstore",
                    rating: 4.3
                },
                {
                    name: "Nh√† s√°ch Ph∆∞∆°ng Nam",
                    lat: 21.0351,
                    lng: 105.8342,
                    address: "18 Nguy·ªÖn Tri Ph∆∞∆°ng, Ba ƒê√¨nh",
                    type: "bookstore",
                    rating: 4.4
                },
                {
                    name: "Th∆∞ vi·ªán Qu·ªëc gia",
                    lat: 21.0223,
                    lng: 105.8541,
                    address: "31 Tr√†ng Thi, Ho√†n Ki·∫øm",
                    type: "library",
                    rating: 4.6
                },
                {
                    name: "Nh√† s√°ch T√¢n Vi·ªát",
                    lat: 21.0286,
                    lng: 105.8463,
                    address: "25 L√Ω Th∆∞·ªùng Ki·ªát, Ho√†n Ki·∫øm",
                    type: "bookstore",
                    rating: 4.1
                },
                {
                    name: "C·ª≠a h√†ng s√°ch c≈© H√† N·ªôi",
                    lat: 21.0321,
                    lng: 105.8498,
                    address: "56 ƒê∆∞·ªùng Th√†nh, Ho√†n Ki·∫øm",
                    type: "bookstore",
                    rating: 4.7
                }
            ];

            // X√≥a c√°c marker c≈©
            bookstoreLayer.clearLayers();

            // L·ªçc c√°c nh√† s√°ch trong b√°n k√≠nh 5km
            const nearbyBookstores = hanoiBookstores.filter(store => {
                const distance = calculateDistance(
                    currentLocation[0], currentLocation[1],
                    store.lat, store.lng
                );
                return distance <= 5; // 5km
            });

            // N·∫øu kh√¥ng t√¨m th·∫•y nh√† s√°ch n√†o trong b√°n k√≠nh, hi·ªÉn th·ªã t·∫•t c·∫£
            const storesToShow = nearbyBookstores.length > 0 ? nearbyBookstores : hanoiBookstores;

            // Th√™m marker cho m·ªói nh√† s√°ch
            storesToShow.forEach(bookstore => {
                const distance = calculateDistance(
                    currentLocation[0], currentLocation[1],
                    bookstore.lat, bookstore.lng
                );

                const marker = L.marker([bookstore.lat, bookstore.lng], {
                    icon: L.divIcon({
                        className: 'bookstore-marker',
                        iconSize: [16, 16]
                    })
                }).addTo(bookstoreLayer);

                const popupContent = `
                    <div style="padding: 8px; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;">
                            ${bookstore.name}
                        </h3>
                        <p style="margin: 0 0 6px 0; color: #64748b; font-size: 12px;">
                            üìç ${bookstore.address}
                        </p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #f59e0b; font-size: 12px;">
                                ‚≠ê ${bookstore.rating}/5
                            </span>
                            <span style="color: #3b82f6; font-size: 11px; font-weight: 500;">
                                ${distance.toFixed(1)}km
                            </span>
                        </div>
                        <p style="margin: 6px 0 0 0; color: #8b5cf6; font-size: 11px; text-transform: uppercase;">
                            ${bookstore.type === 'library' ? 'üìñ Th∆∞ vi·ªán' : 'üìö Nh√† s√°ch'}
                        </p>
                    </div>
                `;

                marker.bindPopup(popupContent);
            });

            updateLocationInfo(
                `‚úÖ ƒê√£ t√¨m th·∫•y ${storesToShow.length} nh√† s√°ch/th∆∞ vi·ªán g·∫ßn b·∫°n${
                    nearbyBookstores.length === 0 ? ' (hi·ªÉn th·ªã t·∫•t c·∫£)' : ''
                }`,
                'success'
            );

            // Zoom map ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£ c√°c marker
            if (storesToShow.length > 0) {
                const group = new L.featureGroup(storesToShow.map(store =>
                    L.marker([store.lat, store.lng])
                ));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // T√≠nh kho·∫£ng c√°ch gi·ªØa 2 ƒëi·ªÉm (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // B√°n k√≠nh Tr√°i ƒë·∫•t t√≠nh b·∫±ng km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // G·ªçi initMap khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();


            // Smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Scroll animation
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.feature-card').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                card.style.transition = 'all 0.6s ease';
                observer.observe(card);
            });
        });
    </script>
</th:block>

</body>
</html>