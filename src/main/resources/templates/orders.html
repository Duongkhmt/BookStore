<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>ƒê∆°n h√†ng c·ªßa t√¥i</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS Variables & Global --- */
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --info-bg: #dbeafe;
            --info-text: #1e40af;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* --- Page Header --- */
        .page-header {
            background: var(--card-bg);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        /* --- Tabs Navigation --- */
        .order-tabs {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 2px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            scrollbar-width: none;
        }
        .order-tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }

        /* --- Order Card --- */
        .order-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Header c·ªßa Card */
        .order-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
        }

        .order-id {
            font-weight: 600;
            color: var(--text-primary);
        }

        .order-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
            padding-left: 0.5rem;
            border-left: 1px solid var(--border-color);
        }

        /* Status Badge */
        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-pending { background: var(--warning-bg); color: var(--warning-text); }
        .badge-confirmed { background: var(--info-bg); color: var(--info-text); }
        .badge-shipping { background: #f3e8ff; color: #6b21a8; }
        .badge-delivered { background: var(--success-bg); color: var(--success-text); }
        .badge-cancelled { background: var(--danger-bg); color: var(--danger-text); }

        /* Body c·ªßa Card */
        .order-body {
            padding: 1.5rem;
        }

        .order-item {
            display: flex;
            gap: 1rem;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .order-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .item-image {
            width: 70px;
            height: 90px;
            background-color: #e5e7eb;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #9ca3af;
            flex-shrink: 0;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .item-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .item-price {
            text-align: right;
        }

        .price-current {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Footer c·ªßa Card */
        .order-footer {
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-price-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .total-price-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ef4444;
        }

        /* N√∫t b·∫•m */
        .btn-modern {
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-outline-primary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .btn-outline-primary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #eff6ff;
        }

        .btn-solid-primary {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }
        .btn-solid-primary:hover {
            background: #1d4ed8;
        }

        /* Loading */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Detail Section Slide Down */
        .detail-section {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-top: 1px dashed var(--border-color);
            font-size: 0.9rem;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .info-label { color: var(--text-secondary); }
        .info-val { font-weight: 500; }

        /* Responsive */
        @media (max-width: 640px) {
            .order-item {
                flex-direction: column;
                gap: 0.5rem;
            }
            .item-image {
                width: 50px;
                height: 70px;
            }
            .item-price {
                text-align: left;
            }
            .order-footer {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-end;
            }
        }
    </style>
</head>

<body>
<div layout:fragment="content">

    <div class="page-header">
        <div class="container">
            <div class="header-content">
                <h1>üì¶ ƒê∆°n h√†ng c·ªßa t√¥i</h1>
                <p class="text-secondary mt-1">Qu·∫£n l√Ω v√† theo d√µi qu√° tr√¨nh v·∫≠n chuy·ªÉn</p>
            </div>
        </div>
    </div>

    <section class="container" style="max-width: 900px; margin: 0 auto; padding-bottom: 3rem;">

        <div style="display: none;" class="mb-4 p-3 bg-gray-100 rounded text-xs">
            <strong>Debug:</strong> <span id="debugInfo">Initializing...</span>
            <button onclick="clearToken()" class="text-red-500 underline ml-2">Clear Token</button>
        </div>

        <div class="order-tabs">
            <button class="tab-btn active" data-status="all">T·∫•t c·∫£ ƒë∆°n</button>
            <button class="tab-btn" data-status="PENDING">Ch·ªù x·ª≠ l√Ω</button>
            <button class="tab-btn" data-status="CONFIRMED">ƒê√£ x√°c nh·∫≠n</button>
            <button class="tab-btn" data-status="SHIPPING">ƒêang giao</button>
            <button class="tab-btn" data-status="DELIVERED">ƒê√£ giao</button>
            <button class="tab-btn" data-status="CANCELLED">ƒê√£ h·ªßy</button>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="loading-spinner"></div>
            <p class="text-secondary mt-3 text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <div id="ordersList"></div>

        <div id="emptyState" class="text-center py-10" style="display: none;">
            <img src="https://cdn-icons-png.flaticon.com/512/4076/4076432.png" alt="Empty" style="width: 120px; opacity: 0.5; margin-bottom: 1.5rem;">
            <h3 class="text-lg font-semibold mb-2">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
            <p class="text-secondary mb-4">B·∫°n ch∆∞a mua cu·ªën s√°ch n√†o. H√£y d·∫°o m·ªôt v√≤ng nh√©!</p>
            <a href="/" class="btn-modern btn-solid-primary">Kh√°m ph√° ngay</a>
        </div>

        <div id="errorState" class="text-center py-5" style="display: none;">
            <div class="bg-red-50 text-red-600 p-4 rounded-lg inline-block">
                <h4 class="font-bold" id="errorTitle">L·ªói t·∫£i d·ªØ li·ªáu</h4>
                <p class="text-sm mt-1" id="errorMessage"></p>
                <button onclick="loadOrders()" class="btn-modern btn-outline-primary mt-3 bg-white">Th·ª≠ l·∫°i</button>
            </div>
        </div>

    </section>

    <script layout:fragment="scripts" th:inline="none">
        // --- 1. KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ---
        let allOrders = [];
        let currentUser = null;

        // --- 2. H√ÄM TI·ªÜN √çCH ---
        function formatPrice(price) {
            if (!price && price !== 0) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }

        function getStatusInfo(status) {
            const map = {
                'PENDING': { text: 'Ch·ªù x·ª≠ l√Ω', class: 'badge-pending', icon: 'fa-clock' },
                'CONFIRMED': { text: 'ƒê√£ x√°c nh·∫≠n', class: 'badge-confirmed', icon: 'fa-check-circle' },
                'SHIPPING': { text: 'ƒêang giao', class: 'badge-shipping', icon: 'fa-truck' },
                'DELIVERED': { text: 'Giao th√†nh c√¥ng', class: 'badge-delivered', icon: 'fa-box-open' },
                'CANCELLED': { text: 'ƒê√£ h·ªßy', class: 'badge-cancelled', icon: 'fa-times-circle' }
            };
            return map[status] || { text: status, class: 'badge-pending', icon: 'fa-info-circle' };
        }

        function clearToken() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return null;
            }
            return token;
        }

        // --- 3. H√ÄM G·ªåI API ---

        // G·ªçi API l·∫•y th√¥ng tin c√° nh√¢n (ƒë·ªÉ hi·ªÉn th·ªã SƒêT/ƒê·ªãa ch·ªâ n·∫øu ƒë∆°n h√†ng b·ªã null)
        async function fetchUserProfile() {
            try {
                const token = localStorage.getItem('token');
                // Endpoint n√†y c·∫ßn ƒë∆∞·ª£c khai b√°o b√™n backend
                const res = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const json = await res.json();
                    currentUser = json.data; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
                    console.log("Current User Info:", currentUser);
                }
            } catch (error) {
                console.error("L·ªói l·∫•y th√¥ng tin user:", error);
            }
        }

        // G·ªçi API l·∫•y danh s√°ch ƒë∆°n h√†ng
        async function loadOrders() {
            const loading = document.getElementById('loading');
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');
            const errorState = document.getElementById('errorState');

            loading.style.display = 'block';
            ordersList.innerHTML = '';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';

            try {
                const token = checkAuth();
                if (!token) return;

                // G·ªçi song song: L·∫•y th√¥ng tin user + L·∫•y ƒë∆°n h√†ng
                // ƒê·ªÉ ƒë·∫£m b·∫£o khi render ƒë√£ c√≥ th√¥ng tin currentUser
                await fetchUserProfile();

                const res = await fetch('/api/orders/my-orders', {
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });

                if (!res.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß');

                const json = await res.json();
                const ordersData = json.data || [];

                // L·∫•y chi ti·∫øt t·ª´ng ƒë∆°n h√†ng n·∫øu c·∫ßn (ƒë·ªÉ c√≥ list item)
                allOrders = [];
                for (const order of ordersData) {
                    try {
                        const detailRes = await fetch(`/api/orders/${order.id}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (detailRes.ok) {
                            const detailJson = await detailRes.json();
                            allOrders.push(detailJson.data);
                        } else {
                            allOrders.push(order);
                        }
                    } catch (e) {
                        allOrders.push(order);
                    }
                }

                // S·∫Øp x·∫øp ƒë∆°n m·ªõi nh·∫•t l√™n ƒë·∫ßu
                allOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                if (allOrders.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    renderOrders(allOrders);
                }

            } catch (error) {
                console.error(error);
                document.getElementById('errorMessage').textContent = error.message;
                errorState.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('ordersList');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-secondary">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o ·ªü tr·∫°ng th√°i n√†y.</p>
                    </div>`;
                return;
            }

            container.innerHTML = orders.map(order => {
                const items = order.items || order.orderItems || [];
                const statusInfo = getStatusInfo(order.status);

                // --- X·ª¨ L√ù HI·ªÇN TH·ªä TH√îNG TIN USER ---

                // 1. S·ªë ƒëi·ªán tho·∫°i: ∆Øu ti√™n ƒë∆°n h√†ng -> N·∫øu null th√¨ l·∫•y c·ªßa User ƒëang login
                let displayPhone = order.phone || order.phoneNumber;
                if ((!displayPhone || displayPhone === 'null') && currentUser) {
                    displayPhone = currentUser.phoneNumber;
                }
                if (!displayPhone) displayPhone = '---';

                // 2. ƒê·ªãa ch·ªâ: T∆∞∆°ng t·ª±
                let displayAddress = order.shippingAddress || order.address;
                if((!displayAddress || displayAddress === 'null') && currentUser) {
                    displayAddress = currentUser.address;
                }
                if(!displayAddress) displayAddress = 'Ch∆∞a c·∫≠p nh·∫≠t';

                // 3. T√™n ng∆∞·ªùi nh·∫≠n
                let displayName = order.fullName || (currentUser ? (currentUser.fullName || currentUser.username) : 'B·∫°n');


                const itemsHtml = items.map(item => {
                    const price = item.priceAtOrder || item.price || 0;
                    const imagePlaceholder = `<div class="item-image"><i class="fa-solid fa-book"></i></div>`;

                    return `
                        <div class="order-item">
                            ${imagePlaceholder}
                            <div class="item-details">
                                <div class="item-name">${item.bookTitle || item.book?.title || 'S·∫£n ph·∫©m'}</div>
                                <div class="item-meta">S·ªë l∆∞·ª£ng: x${item.quantity}</div>
                            </div>
                            <div class="item-price">
                                <div class="price-current">${formatPrice(price)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                const trackingHtml = (order.trackingHistory && order.trackingHistory.length > 0)
                    ? `<div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="text-sm font-semibold mb-2">L·ªãch s·ª≠ tr·∫°ng th√°i:</div>
                        ${order.trackingHistory.map(h =>
                        `<div class="text-xs text-secondary flex justify-between mb-1">
                                <span>${getStatusInfo(h.status).text}</span>
                                <span>${formatDate(h.timestamp)}</span>
                            </div>`
                    ).join('')}
                       </div>`
                    : '';

                // HTML c·ªßa Card
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="flex items-center">
                                <span class="order-id">#${order.id}</span>
                                <span class="order-date">${formatDate(order.orderDate)}</span>
                            </div>
                            <div class="badge ${statusInfo.class}">
                                <i class="fas ${statusInfo.icon} mr-1"></i> ${statusInfo.text}
                            </div>
                        </div>

                        <div class="order-body">
                            ${itemsHtml || '<p class="text-secondary text-sm">Kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m</p>'}
                        </div>

                        <div id="detail-${order.id}" class="detail-section" style="display: none;">
                            <div class="info-row">
                                <span class="info-label">Ng∆∞·ªùi nh·∫≠n:</span>
                                <span class="info-val">${displayName}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                                <span class="info-val">${displayPhone}</span> </div>
                            <div class="info-row">
                                <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                <span class="info-val" style="text-align:right; max-width: 60%;">${displayAddress}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ph∆∞∆°ng th·ª©c thanh to√°n:</span>
                                <span class="info-val">${order.paymentMethod || 'COD'}</span>
                            </div>
                            ${trackingHtml}
                        </div>

                        <div class="order-footer">
                            <div>
                                <span class="total-price-label">Th√†nh ti·ªÅn:</span>
                                <span class="total-price-value">${formatPrice(order.totalAmount)}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-modern btn-outline-primary" onclick="toggleDetail(${order.id}, this)">
                                    Xem chi ti·∫øt
                                </button>
                                ${order.status === 'SHIPPING' || order.status === 'DELIVERED'
                    ? `<a href="#" class="btn-modern btn-solid-primary">Mua l·∫°i</a>`
                    : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- 4. C√ÅC H√ÄM S·ª∞ KI·ªÜN ---
        function toggleDetail(id, btn) {
            const detailDiv = document.getElementById(`detail-${id}`);
            if (detailDiv.style.display === 'none') {
                detailDiv.style.display = 'block';
                btn.textContent = 'Thu g·ªçn';
                btn.classList.add('active');
            } else {
                detailDiv.style.display = 'none';
                btn.textContent = 'Xem chi ti·∫øt';
                btn.classList.remove('active');
            }
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const status = btn.getAttribute('data-status');
                if (status === 'all') {
                    renderOrders(allOrders);
                } else {
                    const filtered = allOrders.filter(o => o.status === status);
                    renderOrders(filtered);
                }
            });
        });

        // --- 5. KH·ªûI CH·∫†Y ---
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
        });
    </script>
</div>
</body>
</html>