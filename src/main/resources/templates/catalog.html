<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<div layout:fragment="content">
    <section class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">üìñ Danh m·ª•c s√°ch</h1>
                <p class="card-subtitle">Kh√°m ph√° b·ªô s∆∞u t·∫≠p s√°ch ƒëa d·∫°ng c·ªßa ch√∫ng t√¥i</p>
            </div>

            <div class="card-body">
                <!-- Filters -->
                <div class="filters">
                    <div class="filter-row">
                        <div class="form-group search-group">
                            <label class="form-label">T√¨m ki·∫øm</label>
                            <input
                                    type="text"
                                    id="searchInput"
                                    class="form-control"
                                    placeholder="T√¨m theo ti√™u ƒë·ªÅ, t√°c gi·∫£, nh√† xu·∫•t b·∫£n..."
                            />
                        </div>

                        <div class="form-group category-group">
                            <label class="form-label">Th·ªÉ lo·∫°i</label>
                            <select id="categoryFilter" class="form-control">
                                <option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
                            </select>
                        </div>

                        <div class="form-group button-group">
                            <label class="form-label">&nbsp;</label>
                            <button id="reloadBtn" class="btn btn-primary">
                                <span class="btn-text">L√†m m·ªõi</span>
                                <span class="btn-loading" style="display: none;">‚ü≥</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Book Grid -->
                <div id="bookGrid" class="book-grid"></div>

                <!-- Loading State -->
                <div id="loading" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ƒêang t·∫£i s√°ch...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-icon">üìö</div>
                    <h3>Kh√¥ng t√¨m th·∫•y s√°ch ph√π h·ª£p</h3>
                    <p>H√£y th·ª≠ ƒëi·ªÅu ch·ªânh b·ªô l·ªçc t√¨m ki·∫øm c·ªßa b·∫°n</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="error-state" style="display: none;">
                    <div class="alert alert-error">
                        <h4>Kh√¥ng th·ªÉ t·∫£i danh s√°ch s√°ch</h4>
                        <p>Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá h·ªó tr·ª£ n·∫øu v·∫•n ƒë·ªÅ ti·∫øp di·ªÖn.</p>
                        <button onclick="loadBooks()" class="btn btn-outline">Th·ª≠ l·∫°i</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<th:block layout:fragment="script">
    <script>
        let allBooks = [];

        async function loadCategories() {
            try {
                const res = await API.get('/api/categories');
                const json = await res.json();
                const select = document.getElementById('categoryFilter');
                select.innerHTML = '<option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>';

                (json?.data || []).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('L·ªói t·∫£i th·ªÉ lo·∫°i:', error);
            }
        }

        async function loadBooks() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            const errorState = document.getElementById('errorState');
            const bookGrid = document.getElementById('bookGrid');
            const reloadBtn = document.getElementById('reloadBtn');

            loading.style.display = 'flex';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
            bookGrid.innerHTML = '';
            reloadBtn.querySelector('.btn-text').style.display = 'none';
            reloadBtn.querySelector('.btn-loading').style.display = 'inline-block';
            reloadBtn.disabled = true;

            try {
                const res = await API.get('/api/books');
                const json = await res.json();
                allBooks = json?.data || [];

                if (allBooks.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    renderBooks(allBooks);
                }
            } catch (error) {
                console.error('L·ªói t·∫£i s√°ch:', error);
                errorState.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                reloadBtn.querySelector('.btn-text').style.display = 'inline-block';
                reloadBtn.querySelector('.btn-loading').style.display = 'none';
                reloadBtn.disabled = false;
            }
        }

        function renderBooks(books) {
            const grid = document.getElementById('bookGrid');
            const emptyState = document.getElementById('emptyState');

            if (!books || books.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            grid.innerHTML = books.map(book => {
                const safeId = book.id ?? '';
                const safeTitle = book.title ?? 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ';
                const safeAuthor = book.author ?? 'T√°c gi·∫£ ch∆∞a x√°c ƒë·ªãnh';
                const safeCategory = book.category?.name ?? 'Kh√°c';
                const safePrice = book.price ? formatPrice(String(book.price).replace(/,/g, '')) : 'Li√™n h·ªá';

                // T·∫°o ·∫£nh b√¨a t·ª± ƒë·ªông
                const bookCoverUrl = generateBookCover(safeTitle, safeAuthor, safeCategory);
                const imgHtml = `<img src="${bookCoverUrl}" alt="${safeTitle}" class="book-cover" />`;

                return `
        <div class="book-card">
            <div class="book-card-img">${imgHtml}</div>
            <div class="book-card-body">
                <h3 class="book-title">${safeTitle}</h3>
                <p class="book-author">${safeAuthor}</p>
                <p class="book-category">${safeCategory}</p>
                <div class="book-meta">
                    <span class="book-price">${safePrice}</span>
                    <div class="book-actions">
                        <button
                            class="btn btn-outline view-detail-btn"
                            onclick="viewBookDetail('${safeId}')"
                        >
                            Xem chi ti·∫øt
                        </button>
                        <button
                            class="btn btn-primary add-cart-btn"
                            onclick="addToCart(this, '${safeId}')"
                        >
                            Th√™m gi·ªè
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
            }).join('');
        }

        // function renderBooks(books) {
        //     const grid = document.getElementById('bookGrid');
        //     const emptyState = document.getElementById('emptyState');
        //
        //     if (!books || books.length === 0) {
        //         grid.innerHTML = '';
        //         emptyState.style.display = 'block';
        //         return;
        //     }
        //
        //     emptyState.style.display = 'none';
        //
        //     grid.innerHTML = books.map(book => {
        //         const safeId = book.id ?? '';
        //         const safeTitle = book.title ?? 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ';
        //         const safeAuthor = book.author ?? 'T√°c gi·∫£ ch∆∞a x√°c ƒë·ªãnh';
        //         const safeCategory = book.category?.name ?? 'Kh√°c';
        //         const safePrice = book.price ? formatPrice(String(book.price).replace(/,/g, '')) : 'Li√™n h·ªá';
        //         const imgHtml = book.image ? `<img src="${book.image}" alt="${safeTitle}" />` : 'üìñ';
        //
        //         return `
        // <div class="book-card">
        //     <div class="book-card-img">${imgHtml}</div>
        //     <div class="book-card-body">
        //         <h3 class="book-title">${safeTitle}</h3>
        //         <p class="book-author">${safeAuthor}</p>
        //         <p class="book-category">${safeCategory}</p>
        //         <div class="book-meta">
        //             <span class="book-price">${safePrice}</span>
        //             <div class="book-actions">
        //                 <button
        //                     class="btn btn-outline view-detail-btn"
        //                     onclick="viewBookDetail('${safeId}')"
        //                 >
        //                     Xem chi ti·∫øt
        //                 </button>
        //                 <button
        //                     class="btn btn-primary add-cart-btn"
        //                     onclick="addToCart(this, '${safeId}')"
        //                 >
        //                     Th√™m gi·ªè
        //                 </button>
        //             </div>
        //         </div>
        //     </div>
        // </div>`;
        //     }).join('');
        // }

        function formatPrice(price) {
            const num = parseFloat(price);
            if (isNaN(num)) return 'Li√™n h·ªá';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
        }

        async function filterBooks() {
            const searchTerm = document.getElementById('searchInput').value;
            const categoryId = document.getElementById('categoryFilter').value;

            const loading = document.getElementById('loading');
            const bookGrid = document.getElementById('bookGrid');

            loading.style.display = 'flex';
            bookGrid.innerHTML = '';

            try {
                let url;

                if (categoryId) {
                    url = `/api/books/category/${categoryId}`;
                } else if (searchTerm) {
                    url = `/api/books/search?title=${encodeURIComponent(searchTerm)}&author=${encodeURIComponent(searchTerm)}&categoryName=${encodeURIComponent(searchTerm)}`;
                } else {
                    await loadBooks();
                    return;
                }

                const res = await API.get(url);
                const json = await res.json();
                allBooks = json?.data || [];

                renderBooks(allBooks);

            } catch (error) {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                document.getElementById('errorState').style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        async function addToCart(btn, bookId) {
            console.log("üëâ addToCart ƒë√£ ƒë∆∞·ª£c g·ªçi v·ªõi ID =", bookId);

            if (!window.CartManager) {
                console.error('CartManager is not loaded!');
                alert('L·ªói: Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng.');
                return;
            }

            const book = allBooks.find(b => String(b.id) === String(bookId));
            console.log("S√°ch t√¨m ƒë∆∞·ª£c:", book);

            if (!book) {
                console.error(`Kh√¥ng t√¨m th·∫•y s√°ch v·ªõi ID: ${bookId}.`);
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y s√°ch. Vui l√≤ng t·∫£i l·∫°i trang.');
                return;
            }

            const title = book.title ?? 'S√°ch kh√¥ng r√µ t√™n';
            const price = parseFloat(String(book.price).replace(/,/g, '')) || 0;

            try {
                window.CartManager.addToCart(String(book.id), title, price, 1);

                const originalText = btn.textContent;
                btn.textContent = '‚úÖ ƒê√£ th√™m!';
                btn.disabled = true;

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

                window.CartManager.updateCartBadge();
            } catch (error) {
                console.error('L·ªói th√™m v√†o gi·ªè:', error);
                alert('C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng');
            }
        }

        async function viewBookDetail(bookId) {
            try {
                console.log("ƒêang t·∫£i chi ti·∫øt s√°ch ID:", bookId);

                const res = await API.get(`/api/books/${bookId}`);
                const json = await res.json();

                if (json.success && json.data) {
                    showBookDetailModal(json.data);
                } else {
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s√°ch');
                }
            } catch (error) {
                console.error('L·ªói t·∫£i chi ti·∫øt s√°ch:', error);
                alert('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin s√°ch');
            }
        }

        function showBookDetailModal(book) {
            // T·∫°o ·∫£nh b√¨a cho modal
            const bookCoverUrl = generateBookCover(
                book.title || 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ',
                book.author || 'T√°c gi·∫£ ch∆∞a x√°c ƒë·ªãnh',
                book.categoryName || book.category?.name || 'Kh√°c'
            );

            const modalHtml = `
    <div class="modal-overlay" id="bookDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>${book.title || 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ'}</h2>
                <button class="modal-close" onclick="closeBookDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="book-detail">
                    <div class="book-detail-image">
                        <img src="${bookCoverUrl}" alt="${book.title}" class="book-cover-large" />
                    </div>
                    <div class="book-detail-info">
                        <p><strong>T√°c gi·∫£:</strong> ${book.author || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
                        <p><strong>Th·ªÉ lo·∫°i:</strong> ${book.categoryName || book.category?.name || 'Kh√°c'}</p>
                        <p><strong>Nh√† xu·∫•t b·∫£n:</strong> ${book.publisherName || book.publisher?.name || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
                        <p><strong>ISBN:</strong> ${book.isbn || 'Ch∆∞a c√≥'}</p>
                        <p><strong>Gi√°:</strong> ${book.price ? formatPrice(String(book.price).replace(/,/g, '')) : 'Li√™n h·ªá'}</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeBookDetailModal()">ƒê√≥ng</button>
                <button class="btn btn-primary" onclick="addToCartFromDetail('${book.id}')">
                    Th√™m v√†o gi·ªè h√†ng
                </button>
            </div>
        </div>
    </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }


    //     function showBookDetailModal(book) {
    //         const modalHtml = `
    // <div class="modal-overlay" id="bookDetailModal">
    //     <div class="modal-content">
    //         <div class="modal-header">
    //             <h2>${book.title || 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ'}</h2>
    //             <button class="modal-close" onclick="closeBookDetailModal()">&times;</button>
    //         </div>
    //         <div class="modal-body">
    //             <div class="book-detail">
    //                 <div class="book-detail-image">
    //                     ${book.image ? `<img src="${book.image}" alt="${book.title}" />` : 'üìñ'}
    //                 </div>
    //                 <div class="book-detail-info">
    //                     <p><strong>T√°c gi·∫£:</strong> ${book.author || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
    //                     <p><strong>Th·ªÉ lo·∫°i:</strong> ${book.categoryName || book.category?.name || 'Kh√°c'}</p>
    //                     <p><strong>Nh√† xu·∫•t b·∫£n:</strong> ${book.publisherName || book.publisher?.name || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
    //                     <p><strong>ISBN:</strong> ${book.isbn || 'Ch∆∞a c√≥'}</p>
    //                     <p><strong>Gi√°:</strong> ${book.price ? formatPrice(String(book.price).replace(/,/g, '')) : 'Li√™n h·ªá'}</p>
    //                 </div>
    //             </div>
    //         </div>
    //         <div class="modal-footer">
    //             <button class="btn btn-outline" onclick="closeBookDetailModal()">ƒê√≥ng</button>
    //             <button class="btn btn-primary" onclick="addToCartFromDetail('${book.id}')">
    //                 Th√™m v√†o gi·ªè h√†ng
    //             </button>
    //         </div>
    //     </div>
    // </div>`;
    //
    //         document.body.insertAdjacentHTML('beforeend', modalHtml);
    //     }

        function closeBookDetailModal() {
            const modal = document.getElementById('bookDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        function addToCartFromDetail(bookId) {
            addToCart(null, bookId);
            closeBookDetailModal();
        }

        document.addEventListener('click', function(event) {
            const modal = document.getElementById('bookDetailModal');
            if (event.target === modal) {
                closeBookDetailModal();
            }
        });


        // H√†m t·∫°o ·∫£nh b√¨a s√°ch t·ª± ƒë·ªông
        function generateBookCover(title, author, category) {
            // M√†u s·∫Øc theo th·ªÉ lo·∫°i
            const colorThemes = {
                'Khoa h·ªçc': ['#4CAF50', '#388E3C'],
                'VƒÉn h·ªçc': ['#2196F3', '#1976D2'],
                'L·ªãch s·ª≠': ['#FF9800', '#F57C00'],
                'To√°n h·ªçc': ['#9C27B0', '#7B1FA2'],
                'default': ['#607D8B', '#455A64']
            };

            // Ch·ªçn m√†u theo th·ªÉ lo·∫°i
            const categoryKey = Object.keys(colorThemes).find(key =>
                category?.toLowerCase().includes(key.toLowerCase())
            );
            const [color1, color2] = colorThemes[categoryKey] || colorThemes.default;

            // T·∫°o canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 280;

            // Gradient background
            const gradient = ctx.createLinearGradient(0, 0, 200, 280);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 280);

            // Th√™m hi·ªáu ·ª©ng
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(
                    Math.random() * 200,
                    Math.random() * 280,
                    Math.random() * 30 + 10,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }

            // V·∫Ω g√°y s√°ch
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, 10, 280);

            // Ti√™u ƒë·ªÅ s√°ch
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 16px Arial, sans-serif';
            ctx.textAlign = 'center';

            // X·ª≠ l√Ω ti√™u ƒë·ªÅ (xu·ªëng d√≤ng n·∫øu qu√° d√†i)
            const titleLines = wrapText(ctx, title, 160, 16);
            let yPosition = 100;

            titleLines.forEach(line => {
                ctx.fillText(line, 110, yPosition);
                yPosition += 20;
            });

            // ƒê∆∞·ªùng k·∫ª ngang
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.beginPath();
            ctx.moveTo(30, yPosition + 10);
            ctx.lineTo(190, yPosition + 10);
            ctx.stroke();

            // T√°c gi·∫£
            ctx.font = 'italic 12px Arial, sans-serif';
            const authorLines = wrapText(ctx, author, 160, 12);
            yPosition += 30;

            authorLines.forEach(line => {
                ctx.fillText(line, 110, yPosition);
                yPosition += 16;
            });

            // Th·ªÉ lo·∫°i (n·∫øu c√≥)
            if (category) {
                ctx.font = '10px Arial, sans-serif';
                ctx.fillText(category, 110, 260);
            }

            return canvas.toDataURL();
        }

        // H√†m h·ªó tr·ª£ xu·ªëng d√≤ng vƒÉn b·∫£n
        function wrapText(ctx, text, maxWidth, fontSize) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + ' ' + word).width;
                if (width < maxWidth) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);

            // Gi·ªõi h·∫°n s·ªë d√≤ng
            return lines.slice(0, 3);
        }
        document.getElementById('reloadBtn').onclick = loadBooks;
        document.getElementById('categoryFilter').onchange = filterBooks;
        document.getElementById('searchInput').oninput = filterBooks;

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadBooks();

            if (window.CartManager) {
                window.CartManager.updateCartBadge();
            }
        });
    </script>
</th:block>