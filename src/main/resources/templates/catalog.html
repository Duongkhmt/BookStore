
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<div layout:fragment="content">
    <style>
        /* =========================================
           CONFIG & VARIABLES
           ========================================= */
        :root {
            --primary: #6366f1;       /* Indigo */
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --white: #ffffff;
            --text-main: #111827;
            --text-sec: #6b7280;
            --radius: 16px;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { background-color: var(--bg-body); font-family: 'Segoe UI', sans-serif; color: var(--text-main); }
        .container-fluid { max-width: 1280px; margin: 0 auto; padding: 40px 20px; }

        /* SEARCH SECTION */
        .search-section {
            background: var(--white); padding: 30px; border-radius: var(--radius);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); margin-bottom: 40px;
            display: flex; flex-direction: column; gap: 20px;
        }
        .search-header h2 { font-size: 1.5rem; font-weight: 800; margin: 0; display: flex; align-items: center; gap: 10px; }
        .search-controls { display: grid; grid-template-columns: 2fr 1fr auto auto; gap: 15px; }

        .form-control, .form-select {
            padding: 14px 18px; border: 2px solid #e5e7eb; border-radius: 12px;
            outline: none; font-size: 1rem; transition: all 0.2s; background: #f9fafb;
        }
        .form-control:focus { border-color: var(--primary); background: white; }

        .btn-action {
            padding: 0 28px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px; color: white; height: 52px;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-search { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .btn-all { background: white; color: var(--text-main); border: 2px solid #e5e7eb; }
        .btn-all:hover { background: #f9fafb; }

        /* DISPLAY SECTION */
        .section-header { display: flex; justify-content: space-between; align-items: end; margin-bottom: 25px; }
        .section-title {
            font-size: 2rem; font-weight: 900; margin: 0;
            background: linear-gradient(135deg, #111827 0%, #4b5563 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .result-count { font-size: 0.95rem; font-weight: 600; color: var(--text-sec); background: #e5e7eb; padding: 4px 12px; border-radius: 20px; }

        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 30px; }

        .book-card {
            background: var(--white); border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; height: 100%;
        }
        .book-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        .book-img-wrap {
            height: 280px; overflow: hidden; display: flex; justify-content: center; align-items: center;
            background: #f3f4f6; position: relative;
        }
        .book-cover {
            height: 85%; width: auto; object-fit: cover; transition: transform 0.5s ease;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); border-radius: 4px;
        }
        .book-card:hover .book-cover { transform: scale(1.05) rotate(1deg); }

        .book-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .book-tag { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 8px; }
        .book-title { font-weight: 700; margin-bottom: 6px; color: var(--text-main); font-size: 1.1rem; line-height: 1.4; height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .book-author { font-size: 0.9rem; color: var(--text-sec); font-weight: 500; margin-bottom: auto; }

        .book-footer {
            margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        .book-price { color: var(--text-main); font-weight: 800; font-size: 1.2rem; }
        .btn-add-mini {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: #f3f4f6; color: var(--text-main); display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; cursor: pointer; font-weight: bold; font-size: 1.2rem;
        }
        .book-card:hover .btn-add-mini { background: var(--primary); color: white; }

        /* Rating Badge */
        .badge-rating {
            position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.95);
            color: #d97706; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 800;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 4px; z-index: 2;
        }

        /* Loading / Empty */
        .state-msg { text-align: center; padding: 80px 20px; color: var(--text-sec); width: 100%; grid-column: 1 / -1; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; width: 95%; max-width: 950px; max-height: 90vh;
            border-radius: 20px; display: flex; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative;
            flex-direction: row; animation: zoomIn 0.3s ease;
        }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .btn-close-modal {
            position: absolute; top: 15px; right: 15px; background: #f3f4f6; border: none;
            width: 40px; height: 40px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; color: var(--text-sec);
            z-index: 10;
        }
        .btn-close-modal:hover { background: var(--danger); color: white; }

        .modal-left { width: 40%; background: #f9fafb; padding: 40px; display: flex; justify-content: center; align-items: center; }
        .modal-cover-large { width: 100%; max-width: 260px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border-radius: 8px; transform: rotate(-2deg); transition: transform 0.3s; }
        .modal-cover-large:hover { transform: rotate(0deg) scale(1.02); }

        .modal-right { width: 60%; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-tag { display: inline-block; padding: 6px 14px; background: #e0e7ff; color: var(--primary); border-radius: 8px; font-weight: 700; margin-bottom: 12px; font-size: 0.85rem; }
        .modal-title { font-size: 2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px; }
        .modal-desc { background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 25px; line-height: 1.6; border-left: 4px solid var(--primary); }

        /* Recommendation */
        .rec-section { margin-top: auto; padding-top: 25px; border-top: 1px dashed #e5e7eb; }
        .rec-list { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; }
        .rec-item { min-width: 120px; cursor: pointer; transition: transform 0.2s; }
        .rec-item:hover { transform: translateY(-5px); }
        .rec-img { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 5px; }
        .rec-name { font-size: 0.85rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* PAGINATION CONTROLS */
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 30px; }
        .btn-page { padding: 8px 16px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-main); transition: 0.2s; }
        .btn-page:hover:not(:disabled) { background: #f3f4f6; }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-weight: 600; color: var(--text-sec); }

        @media (max-width: 768px) {
            .search-controls { grid-template-columns: 1fr; }
            .modal-box { flex-direction: column; height: 100vh; max-height: none; border-radius: 0; }
            .modal-left { width: 100%; height: 250px; padding: 20px; }
            .modal-cover-large { height: 100%; width: auto; }
            .modal-right { width: 100%; padding: 20px; }
        }
    </style>

    <div class="container-fluid">
        <div class="search-section">
            <div class="search-header">
                <h2>üìö Th∆∞ Vi·ªán S√°ch</h2>
                <p style="color:var(--text-sec)">Kh√°m ph√° h√†ng ng√†n ƒë·∫ßu s√°ch h·∫•p d·∫´n ngay h√¥m nay.</p>
            </div>
            <div class="search-controls">
                <input type="text" id="keyword" class="form-control" placeholder="T√¨m ki·∫øm s√°ch, t√°c gi·∫£..." />
                <select id="category" class="form-select">
                    <option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
                </select>
                <button class="btn-action btn-search" onclick="doSearch()">üîç T√¨m ki·∫øm</button>
                <button class="btn-action btn-all" onclick="doShowAll()">T·∫•t c·∫£</button>
            </div>
        </div>

        <div class="display-section">
            <div class="section-header">
                <h2 id="sectionTitle" class="section-title">üî• S√°ch N·ªïi B·∫≠t</h2>
                <span id="resultCount" class="result-count" style="display: none;">0 k·∫øt qu·∫£</span>
            </div>

            <div id="dynamicGrid" class="book-grid"></div>

            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <button class="btn-page" onclick="changePage(-1)" id="btnPrev">‚ùÆ Tr∆∞·ªõc</button>
                <span class="page-info" id="pageInfo">Trang 1</span>
                <button class="btn-page" onclick="changePage(1)" id="btnNext">Sau ‚ùØ</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay" onclick="closeModal(event)"></div>
</div>

<th:block layout:fragment="script">
    <script th:inline="none">
        const API_BASE = '/api';
        let allBooksCache = [];
        let currentSearchUrl = '';
        let currentPage = 0;
        let totalPages = 1;
        let currentFilter = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadFeaturedBooks();
            document.getElementById('keyword').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') doSearch();
            });
        });

        // 1. DATA LOADING
        async function loadFeaturedBooks() {
            updateUIState("üî• S√°ch N·ªïi B·∫≠t & ƒê√°nh Gi√° Cao", false);
            setLoading(true);
            togglePagination(false);
            try {
                const res = await API.get(`${API_BASE}/books/featured`);
                const json = await res.json();
                if(json.success && json.data) {
                    allBooksCache = json.data;
                    renderGrid(json.data);
                }
            } catch (e) { console.error(e); showError(); }
        }

        function doShowAll() {
            document.getElementById('keyword').value = '';
            document.getElementById('category').value = '';
            updateUIState("üìö T·∫•t c·∫£ s√°ch", true);
            currentPage = 0;
            currentSearchUrl = `${API_BASE}/books`;
            currentFilter = {};
            fetchBooksPage();
        }

        function doSearch() {
            const kw = document.getElementById('keyword').value.trim();
            const cat = document.getElementById('category').value;
            updateUIState("üîé K·∫øt qu·∫£ t√¨m ki·∫øm", true);
            currentPage = 0;
            currentFilter = { categoryId: cat };
            const params = [];
            if(kw) params.push(`keyword=${encodeURIComponent(kw)}`);
            if (kw || cat) {
                currentSearchUrl = `${API_BASE}/books/search?${params.join('&')}`;
            } else {
                currentSearchUrl = `${API_BASE}/books`;
            }
            fetchBooksPage();
        }

        async function fetchBooksPage() {
            setLoading(true);
            try {
                const separator = currentSearchUrl.includes('?') ? '&' : '?';
                const urlWithPage = `${currentSearchUrl}${separator}page=${currentPage}&size=12`;
                const res = await API.get(urlWithPage);
                const json = await res.json();
                let books = [];
                if (json.data && json.data.content) {
                    books = json.data.content;
                    totalPages = json.data.totalPages;
                    togglePagination(true);
                    updatePaginationUI();
                } else if (Array.isArray(json.data)) {
                    books = json.data;
                    togglePagination(false);
                }
                if(currentFilter.categoryId && !currentSearchUrl.includes('filter')) {
                    books = books.filter(b => String(b.categoryId || b.category?.id) === String(currentFilter.categoryId));
                }
                allBooksCache = books;
                updateResultCount(json.data.totalElements || books.length);
                if(books.length === 0) {
                    document.getElementById('dynamicGrid').innerHTML = `
                        <div class="state-msg">
                            <div style="font-size:3rem">üì≠</div>
                            <h3>Kh√¥ng t√¨m th·∫•y s√°ch n√†o</h3>
                        </div>`;
                    togglePagination(false);
                } else {
                    renderGrid(books);
                }
            } catch (e) { console.error(e); showError(); }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                fetchBooksPage();
                document.querySelector('.display-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function updatePaginationUI() {
            document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
            document.getElementById('btnPrev').disabled = (currentPage === 0);
            document.getElementById('btnNext').disabled = (currentPage >= totalPages - 1);
        }
        function togglePagination(show) { document.getElementById('paginationControls').style.display = show ? 'flex' : 'none'; }

        function renderGrid(books) {
            const grid = document.getElementById('dynamicGrid');
            grid.innerHTML = books.map(b => {
                const cover = generateCover(b.title, b.author, b.categoryName);
                const ratingDisplay = (b.averageRating > 0)
                    ? `‚≠ê ${b.averageRating} <span style="font-size:0.7em; color:#6b7280; font-weight:normal;">(${b.totalReviews})</span>`
                    : `üÜï M·ªõi`;
                return `
            <div class="book-card" onclick="openDetail('${b.id}')">
                <div class="book-img-wrap">
                    <div class="badge-rating">${ratingDisplay}</div>
                    <img src="${cover}" class="book-cover" alt="${escapeHtml(b.title)}" />
                </div>
                <div class="book-info">
                    <span class="book-tag">${escapeHtml(b.categoryName || 'General')}</span>
                    <div class="book-title" title="${escapeHtml(b.title)}">${escapeHtml(b.title)}</div>
                    <div class="book-author">${escapeHtml(b.author)}</div>
                    <div class="book-footer">
                        <span class="book-price">${formatPrice(b.price)}</span>
                        <button class="btn-add-mini" title="Th√™m v√†o gi·ªè" onclick="addToCart(event, '${b.id}')"><span>+</span></button>
                    </div>
                </div>
            </div>`;
            }).join('');
        }

        const modalOverlay = document.getElementById('detailModal');
        async function openDetail(bookId) {
            try {
                document.body.style.cursor = 'wait';
                const res = await API.get(`${API_BASE}/books/${bookId}`);
                const json = await res.json();
                if (json.success && json.data) {
                    renderModalContent(json.data);
                    modalOverlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    loadRecommendations(bookId);
                } else { alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s√°ch!'); }
            } catch (error) { console.error(error); alert('L·ªói k·∫øt n·ªëi.'); }
            finally { document.body.style.cursor = 'default'; }
        }

        function renderModalContent(book) {
            const cover = generateCover(book.title, book.author, book.categoryName);
            const desc = book.description ? escapeHtml(book.description) : 'Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt.';
            modalOverlay.innerHTML = `
                <div class="modal-box" onclick="event.stopPropagation()">
                    <button class="btn-close-modal" onclick="closeModal()">‚úï</button>
                    <div class="modal-left"><img src="${cover}" class="modal-cover-large" /></div>
                    <div class="modal-right">
                        <div>
                            <span class="modal-tag">${escapeHtml(book.categoryName || 'General')}</span>
                            <h2 class="modal-title">${escapeHtml(book.title)}</h2>
                            <p class="modal-author">T√°c gi·∫£: ${escapeHtml(book.author)}</p>
                            <div class="modal-desc"><strong>Gi·ªõi thi·ªáu:</strong><br>${desc}</div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                                <div style="font-size:1.8rem; font-weight:800;">${formatPrice(book.price)}</div>
                                <button class="btn-action btn-search" onclick="addToCart(event, '${book.id}')">üõí Th√™m v√†o gi·ªè</button>
                            </div>
                        </div>
                        <div class="rec-section">
                            <div class="rec-header">‚ú® C√≥ th·ªÉ b·∫°n c≈©ng th√≠ch</div>
                            <div id="recListContainer" class="rec-list"><div class="spinner" style="width:30px; height:30px;"></div></div>
                        </div>
                    </div>
                </div>`;
        }

        async function loadRecommendations(bookId) {
            const container = document.getElementById('recListContainer');
            if(!container) return;
            try {
                const res = await API.get(`${API_BASE}/books/${bookId}/recommendations`);
                const json = await res.json();
                if(json.success && json.data && json.data.length > 0) {
                    container.innerHTML = json.data.map(b => {
                        const cv = generateCover(b.title, b.author, 'Gen');
                        return `
                        <div class="rec-item" onclick="openDetail('${b.id}')" title="${escapeHtml(b.title)}">
                            <img src="${cv}" class="rec-img" />
                            <div class="rec-name">${escapeHtml(b.title)}</div>
                        </div>`;
                    }).join('');
                } else { container.innerHTML = '<span style="color:#999; font-size:0.9rem">Ch∆∞a c√≥ g·ª£i √Ω ph√π h·ª£p.</span>'; }
            } catch (e) { container.innerHTML = ''; }
        }

        function closeModal(event) {
            if (event && event.target !== modalOverlay) return;
            modalOverlay.style.display = 'none';
            modalOverlay.innerHTML = '';
            document.body.style.overflow = '';
        }

        function addToCart(event, bookId) {
            if(event) event.stopPropagation();
            if(!window.CartManager) { alert("Gi·ªè h√†ng ch∆∞a s·∫µn s√†ng. Vui l√≤ng t·∫£i l·∫°i trang."); return; }
            let book = allBooksCache.find(b => String(b.id) === String(bookId));
            if(!book) { book = { id: bookId, title: 'ƒêang t·∫£i...', price: 0 }; }
            window.CartManager.addToCart(String(bookId), book.title, book.price, 1);
            window.CartManager.updateCartBadge();
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            const originalBg = btn.style.background;
            btn.innerHTML = '‚úî'; btn.style.background = '#10b981'; btn.style.color = 'white';
            setTimeout(() => { btn.innerHTML = originalHTML; btn.style.background = originalBg; btn.style.color = ''; }, 1000);
        }

        function updateUIState(title, showCount) {
            document.getElementById('sectionTitle').innerText = title;
            document.getElementById('resultCount').style.display = showCount ? 'inline-block' : 'none';
        }
        function updateResultCount(count) { document.getElementById('resultCount').innerText = `${count} k·∫øt qu·∫£`; }
        function setLoading(isLoading) {
            const grid = document.getElementById('dynamicGrid');
            if(isLoading) grid.innerHTML = '<div class="state-msg"><div class="spinner"></div><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></div>';
        }
        function showError() { document.getElementById('dynamicGrid').innerHTML = '<div class="state-msg" style="color:red">‚ö†Ô∏è L·ªói k·∫øt n·ªëi</div>'; }
        async function loadCategories() {
            try {
                const res = await API.get(`${API_BASE}/categories`);
                const json = await res.json();
                const select = document.getElementById('category');
                (json.data || []).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id; opt.textContent = c.name; select.appendChild(opt);
                });
            } catch(e) {}
        }
        function formatPrice(p) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(p || 0); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }

        function generateCover(title, author, category) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; canvas.height = 450;
            // M·∫£ng m√†u gradient n√†y ch·ª©a [[...]] g√¢y l·ªói cho Thymeleaf n·∫øu kh√¥ng c√≥ th:inline="none"
            const gradients = [['#4f46e5', '#818cf8'], ['#059669', '#34d399'], ['#dc2626', '#f87171'],['#d97706', '#fbbf24'], ['#7c3aed', '#a78bfa'], ['#0891b2', '#22d3ee'],['#db2777', '#f472b6'], ['#2563eb', '#60a5fa'], ['#0f172a', '#334155']];
            let hash = 0; const str = title + (category || '');
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const colorIndex = Math.abs(hash) % gradients.length;
            const [c1, c2] = gradients[colorIndex];
            const grd = ctx.createLinearGradient(0, 0, 300, 450);
            grd.addColorStop(0, c1); grd.addColorStop(1, c2);
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 300, 450);
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath(); ctx.arc(280, 430, 100, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(20, 20, 80, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.font = 'bold 24px Arial';
            const words = (title || 'Book').split(' ');
            let line = '', lines = [];
            for(let i=0; i<words.length; i++) {
                if (ctx.measureText(line + words[i]).width > 240 && i > 0) { lines.push(line); line = words[i] + ' '; }
                else line += words[i] + ' ';
            }
            lines.push(line);
            let startY = 225 - ((lines.length - 1) * 15);
            lines.forEach((l, i) => ctx.fillText(l.trim(), 150, startY + (i * 30)));
            ctx.font = 'italic 16px Arial'; ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillText((author || '').substring(0, 30), 150, 400);
            return canvas.toDataURL();
        }
    </script>
</th:block>
</html>