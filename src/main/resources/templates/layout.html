<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle} ?: 'Bookstore'">Bookstore</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header class="topbar">
    <div class="topbar-content">
        <a href="/" class="brand">ğŸ“š BookStore</a>
        <nav class="nav" id="mainNav">
        </nav>

        <a href="/login" id="loginLink" class="btn btn-outline">ÄÄƒng nháº­p</a>

        <div id="userSection" style="display: none; align-items: center; gap: 15px;">
            <span id="displayUsername" style="color: #fff; font-weight: 600; font-size: 14px;"></span>

            <button id="logoutBtn" class="btn btn-danger">ÄÄƒng xuáº¥t</button>
        </div>
    </div>
</header>

<main layout:fragment="content">
    <!-- Ná»™i dung tá»«ng trang con sáº½ Ä‘Æ°á»£c Thymeleaf thay tháº¿ vÃ o Ä‘Ã¢y -->
</main>
<script th:src="@{/js/cart-logic.js}"></script>
<script th:src="@{/js/auth.js}"></script>
<script th:src="@{/js/api.js}"></script>
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        const hasToken = !!localStorage.getItem('token');
        const loginLink = document.getElementById('loginLink');
        const userSection = document.getElementById('userSection'); // Div bao quanh User + Logout
        const logoutBtn = document.getElementById('logoutBtn');
        const displayUsername = document.getElementById('displayUsername'); // Span hiá»ƒn thá»‹ tÃªn
        const mainNav = document.getElementById('mainNav');

        // 1. Xá»­ lÃ½ hiá»ƒn thá»‹ Login / Logout + User Name
        if (hasToken) {
            if (loginLink) loginLink.style.display = 'none';
            if (userSection) userSection.style.display = 'flex'; // Hiá»‡n cáº£ tÃªn vÃ  nÃºt logout

            // Gá»ŒI API Láº¤Y TÃŠN NGÆ¯á»œI DÃ™NG
            try {
                // DÃ¹ng fetch hoáº·c API.get náº¿u file api.js cá»§a báº¡n Ä‘Ã£ define nÃ³
                // á» Ä‘Ã¢y mÃ¬nh dÃ¹ng fetch native cho cháº¯c cháº¯n cháº¡y Ä‘Æ°á»£c ngay
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const json = await response.json();

                if (json.success && json.data) {
                    // Hiá»ƒn thá»‹ tÃªn: VÃ­ dá»¥ "ğŸ‘¤ admin"
                    if (displayUsername) displayUsername.innerText = `ğŸ‘¤ ${json.data.username}`;
                }
            } catch (e) {
                console.error("Lá»—i láº¥y thÃ´ng tin user", e);
            }

        } else {
            if (loginLink) loginLink.style.display = 'inline-block';
            if (userSection) userSection.style.display = 'none';
        }

        // 2. Xá»­ lÃ½ ÄÄƒng xuáº¥t
        if (logoutBtn) {
            logoutBtn.onclick = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('cart');
                window.location.href = '/login';
            };
        }

        // 3. Xá»­ lÃ½ Menu theo Role (Giá»¯ nguyÃªn logic cÅ© cá»§a báº¡n)
        const userRole = typeof getUserRole === 'function' ? getUserRole() : null;
        console.log('ğŸ¯ Current role:', userRole);

        if (mainNav) {
            if (userRole === 'ADMIN') {
                mainNav.innerHTML = `<a href="/admin">Quáº£n trá»‹ há»‡ thá»‘ng</a>`;
            } else if (userRole === 'USER') {
                mainNav.innerHTML = `
                    <a href="/catalog">SÃ¡ch</a>
                    <a href="/orders">ÄÆ¡n hÃ ng</a>
                    <a href="/cart" class="cart-link">
                        ğŸ›’ Giá» hÃ ng <span id="cartBadge" class="cart-badge" style="display: none;">0</span>
                    </a>`;
            } else {
                mainNav.innerHTML = `<a href="/catalog">SÃ¡ch</a>`;
            }
        }
    });
</script>
<th:block layout:fragment="script"></th:block>
</body>
</html>