<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üìö Qu·∫£n l√Ω s√°ch - BookStore Admin</title>
    <style layout:fragment="styles">
        /* --- STYLE H·ªÜ TH·ªêNG --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; }

        /* THANH T√åM KI·∫æM & B·ªò L·ªåC */
        .search-filter {
            display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;
            background: white; padding: 1rem; border-radius: 0.75rem;
            border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .search-box { flex: 1; min-width: 250px; }
        .filter-select { width: 200px; } /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh cho dropdown */

        .form-control, .search-input {
            width: 100%; padding: 0.6rem 1rem; border: 1px solid #cbd5e1;
            border-radius: 0.5rem; font-size: 0.95rem; transition: all 0.2s;
        }
        .form-control:focus, .search-input:focus { outline: none; border-color: #3b82f6; ring: 2px solid #3b82f6; }

        /* B·∫¢NG D·ªÆ LI·ªÜU */
        .table-container {
            background: white; border-radius: 0.75rem; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            min-height: 300px;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-weight: 600; color: #1e293b; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        /* BUTTONS & BADGES */
        .action-buttons { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;}
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: white; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.75rem; }

        .badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* PAGINATION */
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-bottom: 2rem; }
        .page-info { font-weight: 600; color: #475569; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 0.75rem; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.4rem; font-weight: 500; color: #1e293b; font-size: 0.9rem; }
        .loading { text-align: center; padding: 3rem; color: #64748b; font-style: italic; }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-book"></i> Qu·∫£n l√Ω s√°ch</h2>
        <button class="btn btn-primary" onclick="showBookModal()">
            <i class="fas fa-plus"></i> Th√™m s√°ch
        </button>
    </div>

    <div class="search-filter">
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input"
                   placeholder="üîç T√¨m t√™n s√°ch, t√°c gi·∫£, ISBN..."
                   onkeyup="debounceSearch()">
        </div>

        <div class="filter-select">
            <select id="filterCategory" class="form-control" onchange="resetAndLoad()">
                <option value="">üìÇ T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
            </select>
        </div>

        <div class="filter-select">
            <select id="filterPublisher" class="form-control" onchange="resetAndLoad()">
                <option value="">üè¢ T·∫•t c·∫£ NXB</option>
            </select>
        </div>

        <button class="btn btn-outline" onclick="clearFilters()" title="X√≥a b·ªô l·ªçc" style="width: 40px; padding: 0.5rem;">
            <i class="fas fa-undo"></i>
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th style="width: 250px;">T√™n s√°ch</th>
                <th>T√°c gi·∫£</th>
                <th>Th·ªÉ lo·∫°i</th>
                <th>Gi√° b√°n</th>
                <th>T·ªìn kho</th>
                <th style="width: 150px;">Thao t√°c</th>
            </tr>
            </thead>
            <tbody id="booksTableBody">
            <tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination-controls" style="display: none;">
        <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">‚ùÆ Tr∆∞·ªõc</button>
        <span id="pageInfo" class="page-info">Trang 1</span>
        <button class="btn btn-outline" id="btnNext" onclick="changePage(1)">Sau ‚ùØ</button>
    </div>

    <div id="bookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bookModalTitle" style="margin:0; font-size:1.25rem;">Th√™m s√°ch m·ªõi</h3>
                <button onclick="closeModal('bookModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#64748b;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T√™n s√°ch *</label>
                            <input type="text" id="bookTitle" class="form-control" required placeholder="VD: ƒê·∫Øc Nh√¢n T√¢m">
                        </div>
                        <div class="form-group">
                            <label class="form-label">T√°c gi·∫£ *</label>
                            <input type="text" id="bookAuthor" class="form-control" required placeholder="VD: Dale Carnegie">
                        </div>
                    </div>

                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">ISBN *</label>
                            <input type="text" id="bookIsbn" class="form-control" required placeholder="M√£ ISBN">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gi√° b√°n *</label>
                            <input type="number" id="bookPrice" class="form-control" required min="0" step="1000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">T·ªìn kho</label>
                            <input type="number" id="bookStock" class="form-control" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Th·ªÉ lo·∫°i *</label>
                            <select id="bookCategory" class="form-control" required>
                                <option value="">ƒêang t·∫£i...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nh√† xu·∫•t b·∫£n *</label>
                            <select id="bookPublisher" class="form-control" required>
                                <option value="">ƒêang t·∫£i...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">ƒê·ªô kh√≥</label>
                            <select id="bookDifficulty" class="form-control">
                                <option value="">Ch·ªçn ƒë·ªô kh√≥</option>
                                <option value="BEGINNER">C∆° b·∫£n</option>
                                <option value="INTERMEDIATE">Trung b√¨nh</option>
                                <option value="ADVANCED">N√¢ng cao</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">NƒÉm XB</label>
                            <input type="number" id="bookYear" class="form-control" placeholder="2024">
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë trang</label>
                            <input type="number" id="bookPages" class="form-control" placeholder="300">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">T√≥m t·∫Øt</label>
                        <textarea id="bookSummary" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea id="bookDescription" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bookModal')">H·ªßy b·ªè</button>
                <button class="btn btn-primary" onclick="saveBook()">
                    <i class="fas fa-save"></i> L∆∞u l·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    // --- BI·∫æN TO√ÄN C·ª§C ---
    let currentPage = 0;
    const pageSize = 10;
    let totalPages = 1;
    let editingBookId = null;
    let searchTimeout = null;

    // Cache ƒë·ªÉ d√πng chung cho Filter v√† Modal
    let categoriesCache = [];
    let publishersCache = [];

    // --- KH·ªûI T·∫†O ---
    document.addEventListener('DOMContentLoaded', async () => {
        // T·∫£i danh m·ª•c v√† NXB tr∆∞·ªõc ƒë·ªÉ ƒëi·ªÅn v√†o dropdown
        await Promise.all([loadCategories(), loadPublishers()]);
        // Sau ƒë√≥ m·ªõi t·∫£i s√°ch
        loadBooks();
    });

    // --- 1. T·∫¢I D·ªÆ LI·ªÜU DROPDOWN (Ch·∫°y 1 l·∫ßn ƒë·∫ßu) ---
    async function loadCategories() {
        try {
            const res = await API.get('/api/categories?page=0&size=100');
            const data = await res.json();
            categoriesCache = data.data.content || [];

            // Render v√†o Filter
            const filterHtml = '<option value="">üìÇ T·∫•t c·∫£ th·ªÉ lo·∫°i</option>' +
                categoriesCache.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            document.getElementById('filterCategory').innerHTML = filterHtml;

            // Render v√†o Modal
            const modalHtml = '<option value="">Ch·ªçn th·ªÉ lo·∫°i...</option>' +
                categoriesCache.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            document.getElementById('bookCategory').innerHTML = modalHtml;

        } catch(e) { console.error("L·ªói load categories", e); }
    }

    async function loadPublishers() {
        try {
            const res = await API.get('/api/publishers?page=0&size=100');
            const data = await res.json();
            publishersCache = data.data.content || [];

            // Render v√†o Filter
            const filterHtml = '<option value="">üè¢ T·∫•t c·∫£ NXB</option>' +
                publishersCache.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            document.getElementById('filterPublisher').innerHTML = filterHtml;

            // Render v√†o Modal
            const modalHtml = '<option value="">Ch·ªçn NXB...</option>' +
                publishersCache.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            document.getElementById('bookPublisher').innerHTML = modalHtml;

        } catch(e) { console.error("L·ªói load publishers", e); }
    }

    // --- 2. T·∫¢I DANH S√ÅCH S√ÅCH (CORE LOGIC) ---
    async function loadBooks() {
        const tbody = document.getElementById('booksTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        // L·∫•y gi√° tr·ªã t·ª´ b·ªô l·ªçc
        const keyword = document.getElementById('searchInput').value.trim();
        const categoryId = document.getElementById('filterCategory').value;
        const publisherId = document.getElementById('filterPublisher').value;

        // X√¢y d·ª±ng URL API v·ªõi c√°c tham s·ªë
        let url = `/api/books?page=${currentPage}&size=${pageSize}`;
        if(keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
        if(categoryId) url += `&categoryId=${categoryId}`;
        if(publisherId) url += `&publisherId=${publisherId}`;

        try {
            const response = await API.get(url);
            if(!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            const books = result.data.content;
            totalPages = result.data.totalPages;

            if (!books || books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color: #64748b;">Kh√¥ng t√¨m th·∫•y s√°ch ph√π h·ª£p</td></tr>';
                document.getElementById('pagination').style.display = 'none';
            } else {
                renderTable(books);
                updatePaginationUI();
                document.getElementById('pagination').style.display = 'flex';
            }
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red; padding:2rem;">‚ö†Ô∏è L·ªói: ${error.message}</td></tr>`;
        }
    }

    function renderTable(books) {
        const tbody = document.getElementById('booksTableBody');
        tbody.innerHTML = books.map(book => `
            <tr>
                <td>#${book.id}</td>
                <td>
                    <div style="font-weight:600; color:#1e293b;">${escapeHtml(book.title)}</div>
                    <small style="color:#64748b">ISBN: ${escapeHtml(book.isbn || '-')}</small>
                </td>
                <td>${escapeHtml(book.author)}</td>
                <td><span class="badge badge-info">${escapeHtml(book.categoryName || 'N/A')}</span></td>
                <td style="font-weight:600; color:#166534;">${formatMoney(book.price)}</td>
                <td>
                    <span class="badge ${book.stockQuantity < 10 ? 'badge-danger' : 'badge-success'}">
                        ${book.stockQuantity}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline btn-sm" onclick="editBook(${book.id})" title="S·ª≠a"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteBook(${book.id})" title="X√≥a"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // --- 3. X·ª¨ L√ù S·ª∞ KI·ªÜN L·ªåC & PH√ÇN TRANG ---

    // G·ªçi khi thay ƒë·ªïi dropdown ho·∫∑c g√µ ph√≠m
    function resetAndLoad() {
        currentPage = 0; // Reset v·ªÅ trang 1
        loadBooks();
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(resetAndLoad, 500); // ƒê·ª£i 500ms
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterCategory').value = '';
        document.getElementById('filterPublisher').value = '';
        resetAndLoad();
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadBooks();
        }
    }

    function updatePaginationUI() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btnPrev').disabled = (currentPage === 0);
        document.getElementById('btnNext').disabled = (currentPage >= totalPages - 1);
    }

    // --- 4. CRUD OPERATIONS (CREATE, UPDATE, DELETE) ---
    function showBookModal(book = null) {
        editingBookId = book?.id || null;
        document.getElementById('bookModalTitle').textContent = book ? 'C·∫≠p nh·∫≠t s√°ch' : 'Th√™m s√°ch m·ªõi';
        document.getElementById('bookForm').reset();

        if (book) {
            // Fill data for Edit
            document.getElementById('bookId').value = book.id;
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookAuthor').value = book.author;
            document.getElementById('bookIsbn').value = book.isbn;
            document.getElementById('bookIsbn').disabled = true;
            document.getElementById('bookPrice').value = book.price;
            document.getElementById('bookStock').value = book.stockQuantity;

            document.getElementById('bookCategory').value = book.categoryId || "";
            document.getElementById('bookPublisher').value = book.publisherId || "";
            document.getElementById('bookDifficulty').value = book.difficultyLevel || "";
            document.getElementById('bookYear').value = book.publicationYear || "";
            document.getElementById('bookPages').value = book.pageCount || "";
            document.getElementById('bookSummary').value = book.summary || "";
            document.getElementById('bookDescription').value = book.description || "";
        } else {
            // New Book
            document.getElementById('bookIsbn').disabled = false;
        }
        document.getElementById('bookModal').classList.add('active');
    }

    async function saveBook() {
        const form = document.getElementById('bookForm');
        if(!form.checkValidity()) { form.reportValidity(); return; }

        const data = {
            title: document.getElementById('bookTitle').value.trim(),
            author: document.getElementById('bookAuthor').value.trim(),
            price: parseFloat(document.getElementById('bookPrice').value),
            stockQuantity: parseInt(document.getElementById('bookStock').value),
            categoryId: parseInt(document.getElementById('bookCategory').value),
            publisherId: parseInt(document.getElementById('bookPublisher').value),
            isbn: document.getElementById('bookIsbn').value.trim(),
            difficultyLevel: document.getElementById('bookDifficulty').value || null,
            publicationYear: parseInt(document.getElementById('bookYear').value) || null,
            pageCount: parseInt(document.getElementById('bookPages').value) || null,
            summary: document.getElementById('bookSummary').value.trim(),
            description: document.getElementById('bookDescription').value.trim()
        };

        if (!data.categoryId || !data.publisherId) {
            alert('Vui l√≤ng ch·ªçn Th·ªÉ lo·∫°i v√† NXB'); return;
        }

        try {
            let res;
            if (editingBookId) {
                res = await API.put(`/api/books/${editingBookId}`, data);
            } else {
                res = await API.post('/api/books', data);
            }

            if(res.ok) {
                if(typeof Utils !== 'undefined') Utils.showNotification('Th√†nh c√¥ng', 'success');
                closeModal('bookModal');
                loadBooks();
            } else {
                const err = await res.json();
                alert(err.message);
            }
        } catch(e) { alert(e.message); }
    }

    async function editBook(id) {
        try {
            const res = await API.get(`/api/books/${id}`);
            const json = await res.json();
            showBookModal(json.data);
        } catch(e) { alert('L·ªói t·∫£i th√¥ng tin s√°ch'); }
    }

    async function deleteBook(id) {
        if(!confirm('X√≥a s√°ch n√†y?')) return;
        try {
            const res = await API.delete(`/api/books/${id}`);
            if(res.ok) {
                if(typeof Utils !== 'undefined') Utils.showNotification('ƒê√£ x√≥a', 'success');
                loadBooks();
            } else alert('L·ªói x√≥a');
        } catch(e) {}
    }

    // --- UTILS ---
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); }
    function escapeHtml(t) { return t ? t.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
    function formatMoney(m) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(m || 0); }
</script>
</body>
</html>