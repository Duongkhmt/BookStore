<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üöÄ Trung t√¢m ƒëi·ªÅu h√†nh - BookStore</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style layout:fragment="styles">
        :root {
            --bg-body: #111827;       /* N·ªÅn ƒëen s√¢u */
            --bg-card: #1f2937;       /* N·ªÅn card n·ªïi */
            --text-main: #f9fafb;     /* Tr·∫Øng s√°ng */
            --text-sec: #9ca3af;      /* X√°m nh·∫°t */
            --accent: #6366f1;        /* Indigo - M√†u ch·ªß ƒë·∫°o */
            --success: #10b981;       /* Xanh l√° - TƒÉng tr∆∞·ªüng */
            --danger: #ef4444;        /* ƒê·ªè - C·∫£nh b√°o */
            --warning: #f59e0b;       /* V√†ng - Ch√∫ √Ω */
            --border: #374151;        /* Vi·ªÅn m·ªù */
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); }

        /* GRID LAYOUT */
        .dashboard-container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Row 1: KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }

        /* Row 2: Charts Area */
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }

        /* Row 3: Tables */
        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        /* COMPONENTS */
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 24px;
            border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); border-color: #4b5563; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }

        /* KPI STYLE */
        .kpi-value { font-size: 2rem; font-weight: 700; margin: 10px 0; letter-spacing: -0.02em; }
        .kpi-label { font-size: 0.875rem; color: var(--text-sec); font-weight: 500; }
        .trend-badge {
            font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .trend-up { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .trend-down { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        /* TABLE STYLE */
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th { text-align: left; padding: 12px; color: var(--text-sec); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .custom-table td { padding: 16px 12px; border-bottom: 1px solid rgba(55, 65, 81, 0.5); font-size: 0.9rem; }
        .custom-table tr:last-child td { border-bottom: none; }

        .product-cell { display: flex; align-items: center; gap: 12px; }
        .product-img { width: 40px; height: 50px; border-radius: 4px; object-fit: cover; background: #374151; }

        /* ALERT BOX */
        .alert-box {
            background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);
            color: var(--warning); padding: 12px; border-radius: 8px; font-size: 0.9rem;
            margin-bottom: 12px; display: flex; align-items: center; gap: 10px;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) { .charts-grid, .tables-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="dashboard-container">

        <div style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: end;">
            <div>
                <h2 style="font-size: 1.8rem; font-weight: 800; margin: 0;">Overview</h2>
                <p style="color: var(--text-sec); margin-top: 5px;">D·ªØ li·ªáu c·∫≠p nh·∫≠t Real-time ‚Ä¢ <span id="lastUpdated">--:--</span></p>
            </div>
            <div>
                <select class="card" style="padding: 10px 20px; color: white; cursor: pointer;">
                    <option>H√¥m nay</option>
                    <option>7 ng√†y qua</option>
                    <option>Th√°ng n√†y</option>
                </select>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="card">
                <div class="kpi-label">Doanh thu h√¥m nay</div>
                <div class="kpi-value" id="kpiRevenue">...</div>
                <div id="trendRevenue" class="trend-badge trend-up">
                    <i class="fas fa-arrow-up"></i> 0% so v·ªõi h√¥m qua
                </div>
            </div>
            <div class="card">
                <div class="kpi-label">ƒê∆°n h√†ng m·ªõi</div>
                <div class="kpi-value" id="kpiOrders">...</div>
                <div id="trendOrders" class="trend-badge trend-down">
                    <i class="fas fa-arrow-down"></i> 0% so v·ªõi h√¥m qua
                </div>
            </div>
            <div class="card">
                <div class="kpi-label">Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông</div>
                <div class="kpi-value" id="kpiUsers">...</div>
                <div class="trend-badge" style="background: rgba(99, 102, 241, 0.1); color: var(--accent)">
                    <i class="fas fa-users"></i> Online
                </div>
            </div>
            <div class="card">
                <div class="kpi-label">T·ªâ l·ªá chuy·ªÉn ƒë·ªïi (CVR)</div>
                <div class="kpi-value" id="kpiConversion">...%</div>
                <div class="trend-badge trend-up">Cao h∆°n m·ª©c TB</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-line"></i> Xu h∆∞·ªõng kinh doanh</div>
                </div>
                <div style="height: 350px; position: relative;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="card" style="display: flex; flex-direction: column;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-filter"></i> Ph·ªÖu mua h√†ng</div>
                </div>
                <div style="height: 200px; position: relative; margin-bottom: 20px;">
                    <canvas id="funnelChart"></canvas>
                </div>

                <div style="margin-top: auto;">
                    <div class="card-title" style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-sec);">C·∫¢NH B√ÅO V·∫¨N H√ÄNH</div>
                    <div id="alertBoxContainer">
                        <div class="alert-box">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>ƒêang t·∫£i d·ªØ li·ªáu c·∫£nh b√°o...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tables-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-crown" style="color: #fbbf24;"></i> Top s√°ch b√°n ch·∫°y</div>
                    <a href="#" style="font-size: 0.85rem; color: var(--accent); text-decoration: none;">Xem t·∫•t c·∫£</a>
                </div>
                <table class="custom-table">
                    <thead><tr><th>S√°ch</th><th style="text-align: right;">ƒê√£ b√°n</th><th style="text-align: right;">Doanh thu</th></tr></thead>
                    <tbody id="topProductsBody">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-sec);">ƒêang t·∫£i...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-boxes" style="color: var(--danger);"></i> C·∫£nh b√°o t·ªìn kho</div>
                    <a href="/admin/inventory" style="font-size: 0.85rem; color: var(--accent); text-decoration: none;">Nh·∫≠p h√†ng</a>
                </div>
                <table class="custom-table">
                    <thead><tr><th>S√°ch</th><th style="text-align: right;">C√≤n l·∫°i</th><th style="text-align: right;">Tr·∫°ng th√°i</th></tr></thead>
                    <tbody id="lowStockBody">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-sec);">ƒêang t·∫£i...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    // C·∫•u h√¨nh Global cho ChartJS
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.font.family = "'Inter', sans-serif";

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        setInterval(loadData, 60000); // Auto refresh m·ªói 60s
    });

    async function loadData() {
        // C·∫≠p nh·∫≠t gi·ªù
        document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();

        try {
            // Gi·∫£ l·∫≠p g·ªçi API (B·∫°n thay b·∫±ng ƒë∆∞·ªùng d·∫´n th·∫≠t /api/admin/dashboard)
            // const res = await API.get('/api/admin/dashboard');
            // const data = await res.json();

            // D·ªÆ LI·ªÜU GI·∫¢ L·∫¨P ƒê·ªÇ TEST GIAO DI·ªÜN (Thay b·∫±ng data th·∫≠t t·ª´ Backend)
            const data = {
                revenueToday: 15400000,
                revenueGrowth: 12.5,
                ordersToday: 45,
                ordersGrowth: -5.2,
                activeUsers: 320,
                conversionRate: 3.8,
                chartLabels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'],
                revenueData: [12000000, 19000000, 15000000, 22000000, 18000000, 25000000, 15400000],
                orderData: [30, 45, 38, 60, 55, 70, 45],
                topProducts: [
                    {title: 'Nh√† Gi·∫£ Kim', sold: 120, price: 150000},
                    {title: 'ƒê·∫Øc Nh√¢n T√¢m', sold: 98, price: 120000},
                    {title: 'Tu·ªïi Tr·∫ª ƒê√°ng Gi√°', sold: 85, price: 90000},
                ],
                lowStock: [
                    {title: 'Harry Potter 1', stock: 2},
                    {title: 'D·∫ø M√®n Phi√™u L∆∞u K√Ω', stock: 5},
                ],
                cancellationRate: 4.5
            };

            // 1. Render KPI
            renderKPI('kpiRevenue', 'trendRevenue', data.revenueToday, data.revenueGrowth, true);
            renderKPI('kpiOrders', 'trendOrders', data.ordersToday, data.ordersGrowth, false);
            document.getElementById('kpiUsers').innerText = data.activeUsers;
            document.getElementById('kpiConversion').innerText = data.conversionRate + '%';

            // 2. Render Main Chart (Dual Axis: Line + Bar)
            renderMainChart(data.chartLabels, data.revenueData, data.orderData);

            // 3. Render Funnel (Horizontal Bar)
            renderFunnelChart();

            // 4. Render Tables
            renderTopProducts(data.topProducts);
            renderLowStock(data.lowStock);

            // 5. Render Alerts
            renderAlerts(data.cancellationRate, data.lowStock.length);

        } catch (e) { console.error(e); }
    }

    // --- CHART FUNCTIONS ---
    let mainChartInstance = null;
    function renderMainChart(labels, revenueData, orderData) {
        const ctx = document.getElementById('mainChart').getContext('2d');

        // Gradient Doanh thu
        const gradRev = ctx.createLinearGradient(0, 0, 0, 300);
        gradRev.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
        gradRev.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

        if(mainChartInstance) mainChartInstance.destroy();

        mainChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Doanh thu',
                        data: revenueData,
                        borderColor: '#10b981',
                        backgroundColor: gradRev,
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y',
                        order: 1
                    },
                    {
                        type: 'bar',
                        label: 'ƒê∆°n h√†ng',
                        data: orderData,
                        backgroundColor: 'rgba(99, 102, 241, 0.3)',
                        borderColor: 'rgba(99, 102, 241, 0.8)',
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 20,
                        yAxisID: 'y1',
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { usePointStyle: true, boxWidth: 8 } },
                    tooltip: { backgroundColor: '#111827', titleColor: '#fff', padding: 12, cornerRadius: 8 }
                },
                scales: {
                    y: {
                        type: 'linear', position: 'left',
                        grid: { borderDash: [4, 4], color: '#374151' },
                        ticks: { callback: v => (v/1000000).toFixed(1) + 'M' }
                    },
                    y1: {
                        type: 'linear', position: 'right',
                        grid: { display: false },
                        ticks: { color: '#6366f1' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderFunnelChart() {
        const ctx = document.getElementById('funnelChart').getContext('2d');
        // Gi·∫£ l·∫≠p data funnel
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Xem', 'Gi·ªè h√†ng', 'Thanh to√°n'],
                datasets: [{
                    label: 'Users',
                    data: [1000, 350, 120],
                    backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899'],
                    borderRadius: 4,
                    barThickness: 25
                }]
            },
            options: {
                indexAxis: 'y', // Bi·ªÉu ƒë·ªì ngang
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { display: false } } }
            }
        });
    }

    // --- HELPER FUNCTIONS ---
    function renderKPI(idVal, idTrend, value, growth, isCurrency) {
        document.getElementById(idVal).innerText = isCurrency ? formatMoney(value) : value;
        const trendEl = document.getElementById(idTrend);
        const isUp = growth >= 0;
        trendEl.className = `trend-badge ${isUp ? 'trend-up' : 'trend-down'}`;
        trendEl.innerHTML = `<i class="fas fa-arrow-${isUp ? 'up' : 'down'}"></i> ${Math.abs(growth)}% h√¥m qua`;
    }

    function renderTopProducts(list) {
        const tbody = document.getElementById('topProductsBody');
        tbody.innerHTML = list.map(p => `
            <tr>
                <td>
                    <div class="product-cell">
                        <div class="product-img"></div> <div style="font-weight: 500; color: white;">${p.title}</div>
                    </div>
                </td>
                <td style="text-align: right; color: var(--text-sec);">${p.sold} cu·ªën</td>
                <td style="text-align: right; font-weight: 600; color: var(--success);">${formatMoney(p.sold * p.price)}</td>
            </tr>
        `).join('');
    }

    function renderLowStock(list) {
        const tbody = document.getElementById('lowStockBody');
        if(list.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Kho ·ªïn ƒë·ªãnh</td></tr>';
        else tbody.innerHTML = list.map(p => `
            <tr>
                <td style="font-weight: 500; color: white;">${p.title}</td>
                <td style="text-align: right; color: var(--danger); font-weight: 700;">${p.stock}</td>
                <td style="text-align: right;"><span class="trend-badge trend-down">Nguy c·∫•p</span></td>
            </tr>
        `).join('');
    }

    function renderAlerts(cancelRate, lowStockCount) {
        const container = document.getElementById('alertBoxContainer');
        let html = '';

        if (cancelRate > 10) {
            html += `<div class="alert-box" style="background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: var(--danger);">
                        <i class="fas fa-ban"></i> T·ªâ l·ªá h·ªßy ƒë∆°n cao b·∫•t th∆∞·ªùng (${cancelRate}%)
                     </div>`;
        }
        if (lowStockCount > 0) {
            html += `<div class="alert-box">
                        <i class="fas fa-exclamation-circle"></i> C√≥ ${lowStockCount} s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng
                     </div>`;
        }
        if (html === '') html = '<div style="color:var(--success); font-size:0.9rem"><i class="fas fa-check-circle"></i> H·ªá th·ªëng v·∫≠n h√†nh t·ªët</div>';

        container.innerHTML = html;
    }

    function formatMoney(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
    }
</script>
</body>
</html>