<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üìã Qu·∫£n l√Ω phi·∫øu nh·∫≠p kho - BookStore Admin</title>
    <style layout:fragment="styles">
        /* --- COPY STYLE T·ª™ TRANG KH√ÅC ƒê·ªÇ ƒê·ªíNG B·ªò --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; }

        .table-container {
            background: white; border-radius: 0.75rem; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            min-height: 300px;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-weight: 600; color: #1e293b; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        /* Pagination */
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-bottom: 2rem; }
        .page-info { font-weight: 600; color: #475569; }

        /* Buttons & Badges */
        .action-buttons { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: white; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.75rem; }
        .badge-success { background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }

        /* Create Receipt Modal Specifics */
        .receipt-items-container { max-height: 250px; overflow-y: auto; padding: 1rem; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0.5rem; }
        .receipt-item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; background: white; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0; align-items: end; }
        .form-label-sm { font-size: 0.75rem; color: #64748b; margin-bottom: 0.2rem; display: block; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 0.75rem; width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }
        .form-control { width: 100%; padding: 0.625rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-clipboard-list"></i> Qu·∫£n l√Ω phi·∫øu nh·∫≠p kho</h2>
        <button class="btn btn-primary" onclick="showReceiptModal()">
            <i class="fas fa-plus"></i> T·∫°o phi·∫øu nh·∫≠p
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>M√£ phi·∫øu</th>
                <th>Nh√† cung c·∫•p</th>
                <th>S√°ch nh·∫≠p</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Ng√†y nh·∫≠p</th>
                <th>Ng∆∞·ªùi t·∫°o</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody id="receiptsTableBody">
            <tr><td colspan="7" style="text-align: center; padding: 3rem; color: #64748b;">ƒêang t·∫£i...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination-controls" style="display: none;">
        <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">‚ùÆ Tr∆∞·ªõc</button>
        <span id="pageInfo" class="page-info">Trang 1</span>
        <button class="btn btn-outline" id="btnNext" onclick="changePage(1)">Sau ‚ùØ</button>
    </div>

    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">T·∫°o phi·∫øu nh·∫≠p kho</h3>
                <button onclick="closeModal('receiptModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body">
                <form id="receiptForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label class="form-label-sm">Nh√† cung c·∫•p *</label>
                            <select id="receiptSupplier" class="form-control" required><option value="">ƒêang t·∫£i...</option></select>
                        </div>
                        <div>
                            <label class="form-label-sm">Ghi ch√∫</label>
                            <textarea id="receiptNote" class="form-control" rows="1"></textarea>
                        </div>
                    </div>

                    <label class="form-label-sm">Danh s√°ch s√°ch *</label>
                    <div id="receiptItems" class="receipt-items-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addReceiptItemRow()" style="width: 100%; margin-top: 0.5rem; border-style: dashed;">
                        <i class="fas fa-plus"></i> Th√™m s√°ch
                    </button>

                    <div style="margin-top: 1rem; text-align: right; font-size: 1.2rem; font-weight: bold; color: #166534;">
                        T·ªïng ti·ªÅn: <span id="receiptTotal">0‚Ç´</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('receiptModal')">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveReceipt()">L∆∞u phi·∫øu</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 style="margin:0;">Chi ti·∫øt phi·∫øu nh·∫≠p</h3>
                <button onclick="closeModal('detailModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body" id="detailBody">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('detailModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    // --- VARIABLES ---
    let currentPage = 0;
    const pageSize = 10;
    let totalPages = 1;
    let booksCache = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadReceipts();
        loadSuppliers(); // Load ng·∫ßm ƒë·ªÉ s·∫µn s√†ng cho form t·∫°o
        loadBooks();     // Load ng·∫ßm s√°ch (Gi·ªõi h·∫°n 100 cu·ªën m·ªõi nh·∫•t ƒë·ªÉ demo)
    });

    // --- 1. LOAD DATA (PH√ÇN TRANG) ---
    async function loadReceipts() {
        const tbody = document.getElementById('receiptsTableBody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem; color: #64748b;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        try {
            // G·ªçi API ƒë√£ t·ªëi ∆∞u (Page, kh√¥ng items)
            const response = await API.get(`/api/receipts?page=${currentPage}&size=${pageSize}`);
            const result = await response.json();
            const receipts = result.data.content;
            totalPages = result.data.totalPages;

            if (!receipts || receipts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:2rem; color:#64748b;">Ch∆∞a c√≥ phi·∫øu nh·∫≠p n√†o</td></tr>';
                document.getElementById('pagination').style.display = 'none';
            } else {
                renderTable(receipts);
                updatePaginationUI();
                document.getElementById('pagination').style.display = 'flex';
            }
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">L·ªói: ${e.message}</td></tr>`;
        }
    }

    function renderTable(receipts) {
        const tbody = document.getElementById('receiptsTableBody');
        tbody.innerHTML = receipts.map(r => `
            <tr>
                <td><strong>${r.receiptCode}</strong></td>
                <td>${escapeHtml(r.supplier)}</td>
                <td><span class="badge-success">${r.itemCount} lo·∫°i s√°ch</span></td>
                <td style="font-weight:600; color:#166534;">${formatMoney(r.totalAmount)}</td>
                <td style="color:#64748b;">${formatDate(r.receiptDate)}</td>
                <td>${escapeHtml(r.createdByUsername)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline btn-sm" onclick="viewDetail(${r.id})"><i class="fas fa-eye"></i> Xem</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteReceipt(${r.id})"><i class="fas fa-trash"></i> H·ªßy</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // --- 2. PAGINATION ---
    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadReceipts();
        }
    }
    function updatePaginationUI() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1}`;
        document.getElementById('btnPrev').disabled = (currentPage === 0);
        document.getElementById('btnNext').disabled = (currentPage >= totalPages - 1);
    }

    // --- 3. CREATE FORM LOGIC ---
    async function loadSuppliers() {
        try {
            const res = await API.get('/api/suppliers?page=0&size=100'); // Load 100 NCC
            const data = await res.json();
            const select = document.getElementById('receiptSupplier');
            select.innerHTML = '<option value="">Ch·ªçn nh√† cung c·∫•p...</option>' +
                data.data.content.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        } catch(e){}
    }

    async function loadBooks() {
        try {
            // Th·ª±c t·∫ø n√™n d√πng Search Box, ·ªü ƒë√¢y demo load 100 cu·ªën
            const res = await API.get('/api/books?page=0&size=100');
            const data = await res.json();
            booksCache = data.data.content;
        } catch(e){}
    }

    function showReceiptModal() {
        document.getElementById('receiptForm').reset();
        document.getElementById('receiptItems').innerHTML = '';
        document.getElementById('receiptTotal').textContent = '0‚Ç´';
        addReceiptItemRow();
        document.getElementById('receiptModal').classList.add('active');
    }

    function addReceiptItemRow() {
        const container = document.getElementById('receiptItems');
        const div = document.createElement('div');
        div.className = 'receipt-item-row';

        const bookOptions = '<option value="">Ch·ªçn s√°ch...</option>' +
            booksCache.map(b => `<option value="${b.id}" data-price="${b.price}">${escapeHtml(b.title)}</option>`).join('');

        div.innerHTML = `
            <div>
                <label class="form-label-sm">S√°ch</label>
                <select class="form-control item-book" onchange="onBookSelect(this)">${bookOptions}</select>
            </div>
            <div>
                <label class="form-label-sm">S·ªë l∆∞·ª£ng</label>
                <input type="number" class="form-control item-qty" value="1" min="1" oninput="calcTotal()">
            </div>
            <div>
                <label class="form-label-sm">Gi√° nh·∫≠p</label>
                <input type="number" class="form-control item-price" value="0" min="0" oninput="calcTotal()">
            </div>
            <div>
                <label class="form-label-sm">Th√†nh ti·ªÅn</label>
                <div class="item-subtotal" style="padding-top:0.5rem; font-weight:bold; font-size:0.9rem;">0‚Ç´</div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)" style="height:38px"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(div);
    }

    function onBookSelect(select) {
        // G·ª£i √Ω gi√° nh·∫≠p = gi√° b√°n
        const option = select.options[select.selectedIndex];
        const price = option.getAttribute('data-price') || 0;
        select.closest('.receipt-item-row').querySelector('.item-price').value = price;
        calcTotal();
    }

    function calcTotal() {
        let total = 0;
        document.querySelectorAll('.receipt-item-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const sub = qty * price;
            row.querySelector('.item-subtotal').textContent = formatMoney(sub);
            total += sub;
        });
        document.getElementById('receiptTotal').textContent = formatMoney(total);
    }

    function removeRow(btn) {
        if(document.querySelectorAll('.receipt-item-row').length > 1) {
            btn.closest('.receipt-item-row').remove();
            calcTotal();
        } else alert("Ph·∫£i c√≥ √≠t nh·∫•t 1 s√°ch");
    }

    async function saveReceipt() {
        const supplierId = document.getElementById('receiptSupplier').value;
        if(!supplierId) { alert('Ch·ªçn NCC!'); return; }

        const items = [];
        let isValid = true;
        document.querySelectorAll('.receipt-item-row').forEach(row => {
            const bookId = row.querySelector('.item-book').value;
            const qty = row.querySelector('.item-qty').value;
            const price = row.querySelector('.item-price').value;
            if(!bookId || qty <= 0 || price < 0) isValid = false;
            items.push({ bookId: bookId, quantity: qty, importPrice: price });
        });

        if(!isValid) { alert('Ki·ªÉm tra l·∫°i s√°ch (s·ªë l∆∞·ª£ng > 0)'); return; }

        try {
            const res = await API.post('/api/receipts', {
                supplierId: supplierId,
                note: document.getElementById('receiptNote').value,
                items: items
            });
            if(res.ok) {
                if(typeof Utils !== 'undefined') Utils.showNotification('Th√†nh c√¥ng', 'success');
                closeModal('receiptModal');
                loadReceipts();
            } else {
                const err = await res.json();
                alert(err.message);
            }
        } catch(e) { alert(e.message); }
    }

    // --- 4. VIEW DETAIL (LAZY LOAD) ---
    async function viewDetail(id) {
        try {
            // B·∫•m xem m·ªõi t·∫£i chi ti·∫øt (Lazy Load)
            const res = await API.get(`/api/receipts/${id}`);
            const json = await res.json();
            const r = json.data;

            const html = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; background:#f8fafc; padding:1rem; border-radius:0.5rem;">
                    <div>
                        <div style="color:#64748b">M√£: <strong style="color:#1e293b">${r.receiptCode}</strong></div>
                        <div style="color:#64748b">NCC: <strong>${escapeHtml(r.supplier)}</strong></div>
                        <div style="color:#64748b">T·∫°o b·ªüi: <strong>${escapeHtml(r.createdByUsername)}</strong></div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.5rem; font-weight:bold; color:#166534">${formatMoney(r.totalAmount)}</div>
                        <div style="color:#64748b">${formatDate(r.receiptDate)}</div>
                    </div>
                </div>
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="text-align:left; border-bottom:1px solid #e2e8f0;"><th>S√°ch</th><th>SL</th><th>Gi√° nh·∫≠p</th><th style="text-align:right">Th√†nh ti·ªÅn</th></tr></thead>
                    <tbody>
                        ${r.items.map(i => `
                            <tr style="border-bottom:1px solid #f1f5f9;">
                                <td style="padding:0.5rem 0;">${escapeHtml(i.bookTitle)}</td>
                                <td>${i.quantity}</td>
                                <td>${formatMoney(i.importPrice)}</td>
                                <td style="text-align:right; font-weight:500;">${formatMoney(i.subtotal)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('active');
        } catch(e) { alert('L·ªói t·∫£i chi ti·∫øt'); }
    }

    async function deleteReceipt(id) {
        if(!confirm('H·ªßy phi·∫øu nh·∫≠p n√†y? (T·ªìn kho s·∫Ω b·ªã tr·ª´ l·∫°i)')) return;
        try {
            const res = await API.delete(`/api/receipts/${id}`);
            if(res.ok) {
                if(typeof Utils !== 'undefined') Utils.showNotification('ƒê√£ h·ªßy', 'success');
                loadReceipts();
            } else alert('L·ªói h·ªßy');
        } catch(e) {}
    }

    // Utils
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); }
    function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
    function formatMoney(m) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(m || 0); }
    function formatDate(d) { return d ? new Date(d).toLocaleString('vi-VN') : ''; }
</script>
</body>
</html>