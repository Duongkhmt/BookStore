<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng - BookStore Admin</title>
    <style layout:fragment="styles">
        /* --- STYLE ƒê·ªíNG B·ªò --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; }

        .table-container {
            background: white; border-radius: 0.75rem; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            min-height: 300px;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-weight: 600; color: #1e293b; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        /* Pagination */
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-bottom: 2rem; }
        .page-info { font-weight: 600; color: #475569; }

        /* Badges */
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Detail Modal */
        .detail-box { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .detail-row { margin-bottom: 0.5rem; color: #64748b; font-size: 0.9rem; }
        .detail-row strong { color: #1e293b; }

        .action-buttons { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #3b82f6; }
        .btn-outline:hover { background: #eff6ff; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.75rem; }

        .loading { text-align: center; padding: 3rem; color: #64748b; font-style: italic; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 0.75rem; width: 95%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-shopping-cart"></i> Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>M√£ ƒë∆°n</th>
                <th>Kh√°ch h√†ng</th>
                <th>Tr·∫°ng th√°i</th>
                <th>S·∫£n ph·∫©m</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Ng√†y ƒë·∫∑t</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody id="ordersTableBody">
            <tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination-controls" style="display: none;">
        <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">‚ùÆ Tr∆∞·ªõc</button>
        <span id="pageInfo" class="page-info">Trang 1</span>
        <button class="btn btn-outline" id="btnNext" onclick="changePage(1)">Sau ‚ùØ</button>
    </div>

    <div id="orderDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">Chi ti·∫øt ƒë∆°n h√†ng</h3>
                <button onclick="closeModal('orderDetailModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailBody"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('orderDetailModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    let currentPage = 0;
    const pageSize = 10;
    let totalPages = 1;

    document.addEventListener('DOMContentLoaded', loadOrders);

    // --- 1. LOAD ORDERS (Server-side Pagination) ---
    async function loadOrders() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        try {
            // G·ªçi API ph√¢n trang, KH√îNG l·∫•y items chi ti·∫øt
            const response = await API.get(`/api/orders?page=${currentPage}&size=${pageSize}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            const orders = result.data.content;
            totalPages = result.data.totalPages;

            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:2rem; color:#64748b;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                document.getElementById('pagination').style.display = 'none';
            } else {
                renderTable(orders);
                updatePaginationUI();
                document.getElementById('pagination').style.display = 'flex';
            }
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red; padding:2rem;">‚ö†Ô∏è L·ªói: ${error.message}</td></tr>`;
        }
    }

    // --- 2. RENDER TABLE ---
    function renderTable(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = orders.map(order => `
            <tr>
                <td><strong>#${order.id}</strong></td>
                <td>
                    <div><strong>${escapeHtml(order.username)}</strong></div>
                    <small style="color:#64748b">${escapeHtml(order.phoneNumber || '')}</small>
                </td>
                <td><span class="badge ${getBadgeClass(order.status)}">${getStatusText(order.status)}</span></td>
                <td><span class="badge" style="background:#f1f5f9; color:#475569">${order.itemCount || 0} m√≥n</span></td>
                <td style="color:#166534; font-weight:bold;">${formatMoney(order.totalAmount)}</td>
                <td style="color:#64748b;">${formatDate(order.orderDate)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline btn-sm" onclick="viewOrderDetail(${order.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-outline btn-sm" onclick="promptUpdateStatus(${order.id}, '${order.status}')"><i class="fas fa-edit"></i></button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // --- 3. PAGINATION ---
    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadOrders();
        }
    }
    function updatePaginationUI() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btnPrev').disabled = (currentPage === 0);
        document.getElementById('btnNext').disabled = (currentPage >= totalPages - 1);
    }

    // --- 4. VIEW DETAIL (LAZY LOAD) ---
    async function viewOrderDetail(id) {
        try {
            // Khi b·∫•m xem m·ªõi g·ªçi API chi ti·∫øt
            const res = await API.get(`/api/orders/${id}`);
            const json = await res.json();
            const order = json.data;

            const itemsHtml = order.items.map(item => {
                // ‚úÖ S·ª¨A ·ªû ƒê√ÇY: G·ªçi ƒë√∫ng t√™n bi·∫øn priceAtOrder
                const price = item.priceAtOrder || 0;
                const subtotal = item.subtotal || 0;

                return `
            <tr style="border-bottom:1px solid #f1f5f9">
                <td style="padding:0.5rem 0;">${escapeHtml(item.bookTitle)}</td>

                <td>${formatMoney(price)}</td>

                <td>${item.quantity}</td>

                <td style="text-align: right; color: #166534; font-weight: 500;">
                    ${formatMoney(subtotal)}
                </td>
            </tr>`;
            }).join('');
            const html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="detail-box">
                        <h4 style="margin-top:0; color:#3b82f6;">Th√¥ng tin ƒë∆°n h√†ng</h4>
                        <div class="detail-row"><strong>M√£ ƒë∆°n:</strong> #${order.id}</div>
                        <div class="detail-row"><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDate(order.orderDate)}</div>
                        <div class="detail-row"><strong>Tr·∫°ng th√°i:</strong> <span class="badge ${getBadgeClass(order.status)}">${getStatusText(order.status)}</span></div>
                        <div class="detail-row"><strong>T·ªïng ti·ªÅn:</strong> <span style="color:#166534; font-size:1.2rem; font-weight:bold">${formatMoney(order.totalAmount)}</span></div>
                    </div>
                    <div class="detail-box">
                        <h4 style="margin-top:0; color:#3b82f6;">Ng∆∞·ªùi nh·∫≠n</h4>
                        <div class="detail-row"><strong>T√™n:</strong> ${escapeHtml(order.fullName || order.username)}</div>
                        <div class="detail-row"><strong>SƒêT:</strong> ${escapeHtml(order.phoneNumber || '---')}</div>
                        <div class="detail-row"><strong>ƒê·ªãa ch·ªâ:</strong> ${escapeHtml(order.shippingAddress || '---')}</div>
                    </div>
                </div>
                <h4 style="margin-bottom:0.5rem; color:#1e293b;">Chi ti·∫øt s·∫£n ph·∫©m</h4>
                <div class="table-container" style="min-height:auto; max-height:300px; overflow-y:auto;">
                    <table style="width:100%">
                        <thead><tr style="text-align:left; border-bottom:1px solid #e2e8f0;"><th>S·∫£n ph·∫©m</th><th>ƒê∆°n gi√°</th><th>SL</th><th style="text-align:right">Th√†nh ti·ªÅn</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                </div>
            `;
            document.getElementById('orderDetailBody').innerHTML = html;
            document.getElementById('orderDetailModal').classList.add('active');
        } catch (e) { alert('L·ªói t·∫£i chi ti·∫øt: ' + e.message); }
    }

    // --- 5. UPDATE STATUS ---
    async function promptUpdateStatus(id, currentStatus) {
        // C√≥ th·ªÉ d√πng Modal ƒë·∫πp h∆°n, nh∆∞ng prompt cho nhanh
        const newStatus = prompt("Nh·∫≠p tr·∫°ng th√°i m·ªõi (PENDING, SHIPPED, DELIVERED, CANCELLED):", currentStatus);
        if(newStatus && newStatus !== currentStatus) {
            try {
                const res = await API.put(`/api/orders/${id}/status`, {
                    newStatus: newStatus.toUpperCase(),
                    note: "C·∫≠p nh·∫≠t b·ªüi Admin"
                });

                if(res.ok) {
                    if(typeof Utils !== 'undefined') Utils.showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng', 'success');
                    loadOrders(); // T·∫£i l·∫°i trang hi·ªán t·∫°i
                } else {
                    alert('L·ªói c·∫≠p nh·∫≠t');
                }
            } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
        }
    }

    // Utils
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); }
    function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
    function formatMoney(m) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(m || 0); }
    function formatDate(d) { return d ? new Date(d).toLocaleString('vi-VN') : ''; }

    function getBadgeClass(status) {
        return {'PENDING':'badge-warning','SHIPPED':'badge-info','DELIVERED':'badge-success','CANCELLED':'badge-danger'}[status] || 'badge-info';
    }
    function getStatusText(status) {
        return {'PENDING':'Ch·ªù x·ª≠ l√Ω','SHIPPED':'ƒêang giao','DELIVERED':'Giao th√†nh c√¥ng','CANCELLED':'ƒê√£ h·ªßy'}[status] || status;
    }
</script>
</body>
</html>