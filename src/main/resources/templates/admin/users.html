<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng - BookStore Admin</title>
    <style layout:fragment="styles">
        /* --- GI·ªÆ NGUY√äN CSS C∆† B·∫¢N --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; }

        .table-container {
            background: white; border-radius: 0.75rem; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            min-height: 300px; /* Tr√°nh gi·∫≠t layout khi load */
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-weight: 600; color: #1e293b; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; color: #334155; }
        tr:hover { background: #f8fafc; }

        .action-buttons { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: white; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-outline:hover { background: #eff6ff; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.75rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #e2e8f0; color: #94a3b8; border-color: #cbd5e1; }

        /* Badge Styles */
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* --- CSS M·ªöI CHO PH√ÇN TRANG --- */
        .pagination-controls {
            display: flex; justify-content: center; align-items: center; gap: 1rem;
            margin-top: 1.5rem; padding-bottom: 2rem;
        }
        .page-info { font-weight: 600; color: #475569; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 0.75rem; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #1e293b; }
        .form-control { width: 100%; padding: 0.625rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.95rem; }
        .form-control:focus { outline: none; border-color: #3b82f6; ring: 2px solid rgba(59, 130, 246, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        .loading { text-align: center; padding: 3rem; color: #64748b; font-style: italic; }
    </style>
</head>
<body>
<div layout:fragment="content">

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-users"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
        <button class="btn btn-primary" onclick="showUserModal()">
            <i class="fas fa-plus"></i> Th√™m ng∆∞·ªùi d√πng
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                <th>Email</th>
                <th>SƒêT</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Vai tr√≤</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody id="usersTableBody">
            <tr><td colspan="8" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination-controls" style="display: none;">
        <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">
            <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
        </button>
        <span id="pageInfo" class="page-info">Trang 1 / 1</span>
        <button class="btn btn-outline" id="btnNext" onclick="changePage(1)">
            Sau <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle" style="margin:0; font-size:1.25rem;">Th√™m ng∆∞·ªùi d√πng</h3>
                <button onclick="closeModal('userModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#64748b;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T√™n ƒëƒÉng nh·∫≠p *</label>
                            <input type="text" id="username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" id="phoneNumber" class="form-control" placeholder="09xxxx...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ƒê·ªãa ch·ªâ</label>
                            <input type="text" id="address" class="form-control" placeholder="H√† N·ªôi...">
                        </div>
                    </div>

                    <div class="form-group" id="passwordGroup">
                        <label class="form-label">M·∫≠t kh·∫©u *</label>
                        <input type="password" id="password" class="form-control">
                        <small style="color: #64748b; font-size: 0.85rem;">T·ªëi thi·ªÉu 6 k√Ω t·ª±</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Vai tr√≤ *</label>
                            <select id="role" class="form-control" required>
                                <option value="ROLE_USER">Ng∆∞·ªùi d√πng (User)</option>
                                <option value="ROLE_ADMIN">Qu·∫£n tr·ªã vi√™n (Admin)</option>
                            </select>
                        </div>
                        <div class="form-group" id="statusGroup" style="display: none;">
                            <label class="form-label">Tr·∫°ng th√°i *</label>
                            <select id="status" class="form-control">
                                <option value="ACTIVE">ƒêang ho·∫°t ƒë·ªông</option>
                                <option value="INACTIVE">Kh√¥ng ho·∫°t ƒë·ªông</option>
                                <option value="LOCKED">ƒê√£ kh√≥a</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('userModal')">H·ªßy b·ªè</button>
                <button class="btn btn-primary" onclick="saveUser()">
                    <i class="fas fa-save"></i> L∆∞u l·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ---
    let currentPage = 0;
    const pageSize = 10; // Ch·ªâ t·∫£i 10 user m·ªói l·∫ßn ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô
    let totalPages = 1;
    let editingUserId = null;

    // Kh·ªüi ch·∫°y khi trang load xong
    document.addEventListener('DOMContentLoaded', loadUsers);

    // --- 1. H√ÄM T·∫¢I D·ªÆ LI·ªÜU (OPTIMIZED) ---
    async function loadUsers() {
        const tbody = document.getElementById('usersTableBody');
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
        tbody.innerHTML = '<tr><td colspan="8" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        try {
            // G·ªçi API v·ªõi tham s·ªë ph√¢n trang
            const response = await API.get(`/api/admin/users?page=${currentPage}&size=${pageSize}`);

            if (!response.ok) throw new Error(`L·ªói HTTP: ${response.status}`);

            const result = await response.json();

            // X·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ Page<UserResponse>
            const users = result.data.content;
            totalPages = result.data.totalPages;
            const totalElements = result.data.totalElements;

            // Render b·∫£ng
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 2rem;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                document.getElementById('pagination').style.display = 'none';
            } else {
                renderTable(users);
                updatePaginationUI();
                document.getElementById('pagination').style.display = 'flex';
            }

        } catch (error) {
            console.error('L·ªói loadUsers:', error);
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red; padding:2rem;">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}</td></tr>`;
        }
    }

    // --- 2. H√ÄM RENDER HTML ---
    function renderTable(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>#${user.id}</td>
                <td><strong>${escapeHtml(user.username)}</strong></td>
                <td>${escapeHtml(user.email)}</td>
                <td>${escapeHtml(user.phoneNumber || '-')}</td>
                <td>${escapeHtml(user.address || '-')}</td>
                <td>
                    <span class="badge ${user.role === 'ROLE_ADMIN' ? 'badge-danger' : 'badge-info'}">
                        ${user.role === 'ROLE_ADMIN' ? 'ADMIN' : 'USER'}
                    </span>
                </td>
                <td>
                    <span class="badge ${getStatusBadgeClass(user.status)}">
                        ${getStatusText(user.status)}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline btn-sm" onclick="editUser(${user.id})" title="S·ª≠a">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})" title="X√≥a">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // --- 3. X·ª¨ L√ù PH√ÇN TRANG ---
    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadUsers(); // Ch·ªâ t·∫£i l·∫°i 10 d√≤ng m·ªõi
        }
    }

    function updatePaginationUI() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btnPrev').disabled = (currentPage === 0);
        document.getElementById('btnNext').disabled = (currentPage >= totalPages - 1);
    }

    // --- 4. C√ÅC H√ÄM MODAL & FORM ---
    function showUserModal(user = null) {
        editingUserId = user?.id || null;
        const modalTitle = document.getElementById('userModalTitle');
        const form = document.getElementById('userForm');

        // Reset form
        form.reset();

        if (user) {
            // Ch·∫ø ƒë·ªô S·ª≠a
            modalTitle.textContent = 'C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('username').disabled = true; // Kh√¥ng cho s·ª≠a username
            document.getElementById('email').value = user.email;
            document.getElementById('phoneNumber').value = user.phoneNumber || '';
            document.getElementById('address').value = user.address || '';
            document.getElementById('role').value = user.role;
            document.getElementById('status').value = user.status;

            // ·∫®n m·∫≠t kh·∫©u, hi·ªán tr·∫°ng th√°i
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('statusGroup').style.display = 'block';
            document.getElementById('password').removeAttribute('required');
        } else {
            // Ch·∫ø ƒë·ªô Th√™m m·ªõi
            modalTitle.textContent = 'Th√™m ng∆∞·ªùi d√πng m·ªõi';
            document.getElementById('username').disabled = false;

            // Hi·ªán m·∫≠t kh·∫©u, ·∫©n tr·∫°ng th√°i (m·∫∑c ƒë·ªãnh Active)
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('statusGroup').style.display = 'none';
            document.getElementById('password').setAttribute('required', '');
        }

        document.getElementById('userModal').classList.add('active');
    }

    async function saveUser() {
        // Validate ƒë∆°n gi·∫£n
        const form = document.getElementById('userForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const data = {
            username: document.getElementById('username').value.trim(),
            email: document.getElementById('email').value.trim(),
            phoneNumber: document.getElementById('phoneNumber').value.trim(),
            address: document.getElementById('address').value.trim(),
            role: document.getElementById('role').value
        };

        try {
            let method = 'POST';
            let url = '/api/admin/users';

            if (editingUserId) {
                // Update
                method = 'PUT';
                url = `/api/admin/users/${editingUserId}`;
                data.status = document.getElementById('status').value;
            } else {
                // Create
                data.password = document.getElementById('password').value;
                if (data.password.length < 6) {
                    alert('M·∫≠t kh·∫©u qu√° ng·∫Øn!'); return;
                }
            }

            const response = await API.fetch(url, {
                method: method,
                body: JSON.stringify(data) // API wrapper c·ªßa b·∫°n s·∫Ω lo headers
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'L·ªói x·ª≠ l√Ω');
            }

            const result = await response.json();

            // Hi·ªÉn th·ªã th√¥ng b√°o (n·∫øu c√≥ th∆∞ vi·ªán Utils)
            if (typeof Utils !== 'undefined') Utils.showNotification(result.message, 'success');
            else alert('Th√†nh c√¥ng!');

            closeModal('userModal');
            loadUsers(); // T·∫£i l·∫°i trang hi·ªán t·∫°i

        } catch (error) {
            alert('‚ùå ' + error.message);
        }
    }

    async function editUser(id) {
        try {
            // L·∫•y chi ti·∫øt user m·ªõi nh·∫•t t·ª´ server
            const res = await API.get(`/api/admin/users/${id}`);
            const json = await res.json();
            if (json.success) showUserModal(json.data);
        } catch (e) {
            alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin user');
        }
    }

    async function deleteUser(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y kh√¥ng?')) return;
        try {
            const res = await API.delete(`/api/admin/users/${id}`);
            if (res.ok) {
                if (typeof Utils !== 'undefined') Utils.showNotification('ƒê√£ x√≥a th√†nh c√¥ng', 'success');
                loadUsers();
            } else {
                alert('Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng n√†y.');
            }
        } catch (e) { console.error(e); }
    }

    // --- UTILS ---
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        editingUserId = null;
    }

    // ƒê√≥ng modal khi click ra ngo√†i
    window.onclick = function(event) {
        const modal = document.getElementById('userModal');
        if (event.target === modal) closeModal('userModal');
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'ACTIVE': return 'badge-success';
            case 'LOCKED': return 'badge-danger';
            default: return 'badge-warning';
        }
    }

    function getStatusText(status) {
        switch(status) {
            case 'ACTIVE': return 'Ho·∫°t ƒë·ªông';
            case 'LOCKED': return 'ƒê√£ kh√≥a';
            case 'INACTIVE': return 'Ng·ª´ng k.ho·∫°t';
            default: return status;
        }
    }
</script>
</body>
</html>