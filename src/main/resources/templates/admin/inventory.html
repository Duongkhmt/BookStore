<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üìä Qu·∫£n l√Ω t·ªìn kho - BookStore Admin</title>
    <style layout:fragment="styles">
        /* --- STYLE ƒê·ªíNG B·ªò --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; text-align: center; }
        .stat-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #1e293b; }

        /* Table */
        .table-container { background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; min-height: 300px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-weight: 600; color: #1e293b; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        /* Pagination */
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-bottom: 2rem; }
        .page-info { font-weight: 600; color: #475569; }

        /* Badges */
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 0.75rem; width: 95%; max-width: 600px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.25rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #1e293b; }
        .form-control { width: 100%; padding: 0.625rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; }

        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #3b82f6; }

        .loading { text-align: center; padding: 3rem; color: #64748b; font-style: italic; }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-boxes"></i> Qu·∫£n l√Ω t·ªìn kho</h2>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showInventoryAdjustModal()">
                <i class="fas fa-exchange-alt"></i> ƒêi·ªÅu ch·ªânh kho
            </button>
            <button class="btn btn-outline" onclick="showInventoryHistoryModal()">
                <i class="fas fa-history"></i> L·ªãch s·ª≠ giao d·ªãch
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-label">T·ªïng s√°ch</div>
            <div class="stat-value" id="totalBooksCount">...</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-label">T·ªïng gi√° tr·ªã kho</div>
            <div class="stat-value" id="totalInventoryValue" style="color: #10b981;">...</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-label">S·∫Øp h·∫øt h√†ng (<10)</div>
            <div class="stat-value" id="lowStockCount" style="color: #f59e0b;">...</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-label">H·∫øt h√†ng (0)</div>
            <div class="stat-value" id="outOfStockCount" style="color: #ef4444;">...</div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>S√°ch</th>
                <th>Th·ªÉ lo·∫°i</th>
                <th>Gi√° b√°n</th>
                <th>T·ªìn kho</th>
                <th>Tr·∫°ng th√°i</th>
            </tr>
            </thead>
            <tbody id="inventoryTableBody">
            <tr><td colspan="5" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination-controls">
        <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">‚ùÆ Tr∆∞·ªõc</button>
        <span id="pageInfo" class="page-info">Trang 1</span>
        <button class="btn btn-outline" id="btnNext" onclick="changePage(1)">Sau ‚ùØ</button>
    </div>

    <div id="inventoryAdjustModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ƒêi·ªÅu ch·ªânh t·ªìn kho</h3><span onclick="closeModal('inventoryAdjustModal')" style="cursor:pointer">&times;</span></div>
            <div class="modal-body">
                <form id="adjustForm">
                    <div class="form-group">
                        <label class="form-label">Ch·ªçn s√°ch</label>
                        <select id="adjustBook" class="form-control"><option>ƒêang t·∫£i...</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lo·∫°i giao d·ªãch</label>
                        <select id="adjustType" class="form-control">
                            <option value="IN">Nh·∫≠p th√™m (+)</option>
                            <option value="OUT">Xu·∫•t b·ªõt (-)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="adjustQty" class="form-control" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">L√Ω do</label>
                        <textarea id="adjustReason" class="form-control" rows="2" placeholder="VD: Ki·ªÉm k√™, H√†ng l·ªói..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('inventoryAdjustModal')">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAdjustment()">L∆∞u</button>
            </div>
        </div>
    </div>

    <div id="inventoryHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header"><h3>L·ªãch s·ª≠ giao d·ªãch kho</h3><span onclick="closeModal('inventoryHistoryModal')" style="cursor:pointer">&times;</span></div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                    <tr style="border-bottom: 2px solid #e2e8f0; text-align: left;">
                        <th style="padding: 0.5rem;">Th·ªùi gian</th>
                        <th style="padding: 0.5rem;">S√°ch</th>
                        <th style="padding: 0.5rem;">Lo·∫°i</th>
                        <th style="padding: 0.5rem;">S·ªë l∆∞·ª£ng</th>
                        <th style="padding: 0.5rem;">L√Ω do</th>
                    </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    <tr><td colspan="5" class="loading">ƒêang t·∫£i...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('inventoryHistoryModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    let currentPage = 0;
    const pageSize = 10;
    let totalPages = 1;

    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadInventory();
        loadBooksForDropdown();
    });

    // 1. Load Stats
    async function loadStats() {
        try {
            const res = await API.get('/api/inventory/stats');
            const stats = (await res.json()).data;
            document.getElementById('totalBooksCount').textContent = stats.totalBooks;
            document.getElementById('totalInventoryValue').textContent = formatMoney(stats.totalValue);
            document.getElementById('lowStockCount').textContent = stats.lowStockCount;
            document.getElementById('outOfStockCount').textContent = stats.outOfStockCount;
        } catch(e) {}
    }

    // 2. Load Inventory (Th·ª±c ch·∫•t l√† load Books c√≥ ph√¢n trang)
    async function loadInventory() {
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>';

        try {
            const res = await API.get(`/api/books?page=${currentPage}&size=${pageSize}`);
            const data = (await res.json()).data;
            const books = data.content;
            totalPages = data.totalPages;

            tbody.innerHTML = books.map(b => `
                <tr>
                    <td><strong>${escapeHtml(b.title)}</strong></td>
                    <td>${escapeHtml(b.categoryName || '-')}</td>
                    <td>${formatMoney(b.price)}</td>
                    <td><span class="badge ${getStockBadge(b.stockQuantity)}">${b.stockQuantity}</span></td>
                    <td>${getStockText(b.stockQuantity)}</td>
                </tr>
            `).join('');

            updatePagination();
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>'; }
    }

    // 3. Load History
    async function showInventoryHistoryModal() {
        document.getElementById('inventoryHistoryModal').classList.add('active');
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading">ƒêang t·∫£i...</td></tr>';

        try {
            // Load 20 giao d·ªãch g·∫ßn nh·∫•t
            const res = await API.get('/api/inventory?page=0&size=20');
            const history = (await res.json()).data.content;

            tbody.innerHTML = history.map(h => `
                <tr style="border-bottom:1px solid #f1f5f9">
                    <td style="padding:0.5rem; color:#64748b">${formatDate(h.timestamp)}</td>
                    <td style="padding:0.5rem">${escapeHtml(h.bookTitle)}</td>
                    <td style="padding:0.5rem"><span class="badge ${h.type === 'IN' ? 'badge-success' : 'badge-danger'}">${h.type}</span></td>
                    <td style="padding:0.5rem; font-weight:bold">${h.quantityChange}</td>
                    <td style="padding:0.5rem; color:#64748b">${escapeHtml(h.reason)}</td>
                </tr>
            `).join('');
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">L·ªói t·∫£i l·ªãch s·ª≠</td></tr>'; }
    }

    // 4. Adjust Logic
    async function loadBooksForDropdown() {
        try {
            const res = await API.get('/api/books?page=0&size=100'); // Demo 100 cu·ªën
            const books = (await res.json()).data.content;
            document.getElementById('adjustBook').innerHTML = books.map(b => `<option value="${b.id}">${escapeHtml(b.title)} (T·ªìn: ${b.stockQuantity})</option>`).join('');
        } catch(e){}
    }

    function showInventoryAdjustModal() {
        document.getElementById('inventoryAdjustModal').classList.add('active');
    }

    async function saveAdjustment() {
        try {
            const res = await API.post('/api/inventory', {
                bookId: document.getElementById('adjustBook').value,
                type: document.getElementById('adjustType').value,
                quantityChange: document.getElementById('adjustQty').value,
                reason: document.getElementById('adjustReason').value
            });
            if(res.ok) {
                alert('Th√†nh c√¥ng');
                closeModal('inventoryAdjustModal');
                loadInventory();
                loadStats();
            } else alert('L·ªói');
        } catch(e) { alert(e.message); }
    }

    // Utils
    function changePage(d) { currentPage += d; if(currentPage>=0 && currentPage<totalPages) loadInventory(); }
    function updatePagination() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1}`;
        document.getElementById('btnPrev').disabled = currentPage === 0;
        document.getElementById('btnNext').disabled = currentPage >= totalPages - 1;
    }
    function getStockBadge(s) { return s===0?'badge-danger':(s<10?'badge-warning':'badge-success'); }
    function getStockText(s) { return s===0?'H·∫øt h√†ng':(s<10?'S·∫Øp h·∫øt':'S·∫µn s√†ng'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function formatMoney(m) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(m || 0); }
    function formatDate(d) { return new Date(d).toLocaleString('vi-VN'); }
    function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
</script>
</body>
</html>