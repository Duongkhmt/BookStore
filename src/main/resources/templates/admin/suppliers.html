<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>üöö Qu·∫£n l√Ω nh√† cung c·∫•p - BookStore Admin</title>
    <style layout:fragment="styles">
        /* --- COPY STYLE ƒê·ªíNG B·ªò --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; }

        .table-container {
            background: white; border-radius: 0.75rem; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            min-height: 300px;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-weight: 600; color: #1e293b; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        .contact-info { font-size: 0.85rem; color: #64748b; margin-top: 0.25rem; }
        .contact-info div { display: flex; align-items: center; gap: 0.5rem; margin-top: 2px; }
        .contact-info i { width: 16px; text-align: center; color: #3b82f6; opacity: 0.8; }

        .supplier-stats { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .stat-badge {
            background: #f1f5f9; color: #0f172a;
            padding: 0.25rem 0.6rem; border-radius: 9999px;
            font-size: 0.75rem; font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        .action-buttons { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: white; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-outline:hover { background: #eff6ff; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.75rem; }

        /* Pagination */
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-bottom: 2rem; }
        .page-info { font-weight: 600; color: #475569; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 0.75rem; width: 95%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #1e293b; }
        .form-control { width: 100%; padding: 0.625rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.95rem; }
        .form-control:focus { outline: none; border-color: #3b82f6; }

        .loading { text-align: center; padding: 3rem; color: #64748b; font-style: italic; }
    </style>
</head>
<body>
<div layout:fragment="content">

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-truck"></i> Qu·∫£n l√Ω nh√† cung c·∫•p</h2>
        <button class="btn btn-primary" onclick="showSupplierModal()">
            <i class="fas fa-plus"></i> Th√™m NCC
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th>T√™n NCC</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Li√™n h·ªá</th>
                <th>Th·ªëng k√™ nh·∫≠p h√†ng</th>
                <th style="width: 120px;">Thao t√°c</th>
            </tr>
            </thead>
            <tbody id="suppliersTableBody">
            <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination-controls" style="display: none;">
        <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">
            <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
        </button>
        <span id="pageInfo" class="page-info">Trang 1 / 1</span>
        <button class="btn btn-outline" id="btnNext" onclick="changePage(1)">
            Sau <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="supplierModalTitle" style="margin:0; font-size:1.25rem;">Th√™m nh√† cung c·∫•p</h3>
                <button onclick="closeModal('supplierModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#64748b;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="supplierForm">
                    <input type="hidden" id="supplierId">
                    <div class="form-group">
                        <label class="form-label">T√™n NCC *</label>
                        <input type="text" id="supplierName" class="form-control" placeholder="C√¥ng ty TNHH..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ng∆∞·ªùi li√™n h·ªá</label>
                        <input type="text" id="contactPerson" class="form-control" placeholder="T√™n ng∆∞·ªùi ƒë·∫°i di·ªán...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ƒê·ªãa ch·ªâ</label>
                        <input type="text" id="supplierAddress" class="form-control" placeholder="ƒê·ªãa ch·ªâ...">
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" id="supplierPhone" class="form-control" placeholder="0987...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="supplierEmail" class="form-control" placeholder="contact@supplier.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√¥ t·∫£ / Ghi ch√∫</label>
                        <textarea id="supplierDescription" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('supplierModal')">H·ªßy b·ªè</button>
                <button class="btn btn-primary" onclick="saveSupplier()">
                    <i class="fas fa-save"></i> L∆∞u l·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts" th:inline="none">
    // --- VARIABLES ---
    let currentPage = 0;
    const pageSize = 10;
    let totalPages = 1;
    let editingSupplierId = null;

    document.addEventListener('DOMContentLoaded', loadSuppliers);

    // --- 1. LOAD DATA (Server-side Pagination) ---
    async function loadSuppliers() {
        const tbody = document.getElementById('suppliersTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        try {
            // G·ªçi API ph√¢n trang, KH√îNG g·ªçi API receipts n·ªØa
            const response = await API.get(`/api/suppliers?page=${currentPage}&size=${pageSize}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            const suppliers = result.data.content;
            totalPages = result.data.totalPages;

            if (!suppliers || suppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem; color:#64748b;">Ch∆∞a c√≥ NCC n√†o</td></tr>';
                document.getElementById('pagination').style.display = 'none';
            } else {
                renderTable(suppliers);
                updatePaginationUI();
                document.getElementById('pagination').style.display = 'flex';
            }

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:2rem;">‚ö†Ô∏è L·ªói: ${error.message}</td></tr>`;
        }
    }

    // --- 2. RENDER TABLE ---
    function renderTable(suppliers) {
        const tbody = document.getElementById('suppliersTableBody');
        tbody.innerHTML = suppliers.map(s => `
            <tr>
                <td>#${s.id}</td>
                <td>
                    <strong>${escapeHtml(s.name)}</strong>
                    ${s.contactPerson ? `<div class="contact-info"><i class="fas fa-user"></i> ${escapeHtml(s.contactPerson)}</div>` : ''}
                </td>
                <td>${escapeHtml(s.address || '-')}</td>
                <td class="contact-info">
                    ${s.phone ? `<div><i class="fas fa-phone"></i> ${escapeHtml(s.phone)}</div>` : ''}
                    ${s.email ? `<div><i class="fas fa-envelope"></i> ${escapeHtml(s.email)}</div>` : ''}
                </td>
                <td>
                    <div class="supplier-stats">
                        <span class="stat-badge">${s.receiptCount || 0} phi·∫øu</span>
                        <span class="stat-badge" style="color: #10b981; border-color: #10b981;">
                            ${formatMoney(s.totalImportAmount)}
                        </span>
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline btn-sm" onclick="prepareEdit('${s.id}', '${escapeJs(s.name)}', '${escapeJs(s.contactPerson)}', '${escapeJs(s.address)}', '${escapeJs(s.phone)}', '${escapeJs(s.email)}', '${escapeJs(s.description)}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplier(${s.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Helper for Money
    function formatMoney(amount) {
        if (!amount) return '0‚Ç´';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // Helper for Edit
    window.prepareEdit = function(id, name, contact, address, phone, email, desc) {
        showSupplierModal({
            id: id,
            name: name,
            contactPerson: (contact === 'undefined' || contact === 'null') ? '' : contact,
            address: (address === 'undefined' || address === 'null') ? '' : address,
            phone: (phone === 'undefined' || phone === 'null') ? '' : phone,
            email: (email === 'undefined' || email === 'null') ? '' : email,
            description: (desc === 'undefined' || desc === 'null') ? '' : desc
        });
    }

    // --- 3. PAGINATION ---
    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadSuppliers();
        }
    }

    function updatePaginationUI() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btnPrev').disabled = (currentPage === 0);
        document.getElementById('btnNext').disabled = (currentPage >= totalPages - 1);
    }

    // --- 4. CRUD OPERATIONS ---
    function showSupplierModal(s = null) {
        editingSupplierId = s?.id || null;
        const title = document.getElementById('supplierModalTitle');
        document.getElementById('supplierForm').reset();

        if (s) {
            title.textContent = 'C·∫≠p nh·∫≠t nh√† cung c·∫•p';
            document.getElementById('supplierId').value = s.id;
            document.getElementById('supplierName').value = s.name || '';
            document.getElementById('contactPerson').value = s.contactPerson || '';
            document.getElementById('supplierAddress').value = s.address || '';
            document.getElementById('supplierPhone').value = s.phone || '';
            document.getElementById('supplierEmail').value = s.email || '';
            document.getElementById('supplierDescription').value = s.description || '';
        } else {
            title.textContent = 'Th√™m nh√† cung c·∫•p';
        }

        document.getElementById('supplierModal').classList.add('active');
        setTimeout(() => document.getElementById('supplierName').focus(), 100);
    }

    async function saveSupplier() {
        const data = {
            name: document.getElementById('supplierName').value.trim(),
            contactPerson: document.getElementById('contactPerson').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            phone: document.getElementById('supplierPhone').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            description: document.getElementById('supplierDescription').value.trim()
        };

        if (!data.name) { alert('Vui l√≤ng nh·∫≠p t√™n NCC'); return; }

        try {
            let res;
            if (editingSupplierId) {
                res = await API.put(`/api/suppliers/${editingSupplierId}`, data);
            } else {
                res = await API.post('/api/suppliers', data);
            }

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'L·ªói l∆∞u d·ªØ li·ªáu');
            }

            const result = await res.json();
            if(typeof Utils !== 'undefined') Utils.showNotification(result.message, 'success');
            else alert('Th√†nh c√¥ng');

            closeModal('supplierModal');
            loadSuppliers();

        } catch (e) { alert('‚ùå ' + e.message); }
    }

    async function deleteSupplier(id) {
        if(!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a NCC n√†y kh√¥ng?')) return;
        try {
            const res = await API.delete(`/api/suppliers/${id}`);
            if(!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'L·ªói x√≥a');
            }
            if(typeof Utils !== 'undefined') Utils.showNotification('ƒê√£ x√≥a th√†nh c√¥ng', 'success');
            loadSuppliers();
        } catch(e) { alert(e.message); }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); editingSupplierId = null; }
    window.onclick = function(event) { if (event.target.id === 'supplierModal') closeModal('supplierModal'); }
    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
    function escapeJs(text) { return text ? text.replace(/'/g, "\\'").replace(/"/g, '&quot;') : ''; }
</script>
</body>
</html>