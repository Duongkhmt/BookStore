
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Gi·ªè h√†ng - BookStore</title>

    <style th:fragment="style">
        .cart-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .cart-header {
            margin-bottom: 2rem;
        }

        .cart-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .cart-empty {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .cart-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .cart-empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .cart-empty-text {
            color: #64748b;
            margin-bottom: 1.5rem;
        }

        .cart-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .cart-content {
                grid-template-columns: 2fr 1fr;
            }
        }

        .cart-items {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .cart-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 100px;
            height: 120px;
            object-fit: cover;
            border-radius: 0.5rem;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
        }

        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .cart-item-price {
            color: #3b82f6;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #f8fafc;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            -moz-appearance: textfield;
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .remove-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            font-weight: 500;
        }

        .remove-btn:hover {
            text-decoration: underline;
        }

        .cart-summary {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            height: fit-content;
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            color: #475569;
        }

        .summary-total {
            border-top: 2px solid #e2e8f0;
            padding-top: 1rem;
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
        }

        .summary-total-label {
            color: #1e293b;
        }

        .summary-total-value {
            color: #3b82f6;
        }

        .checkout-btn {
            width: 100%;
            margin-top: 1.5rem;
            padding: 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        .checkout-btn:hover:not(:disabled) {
            background: #2563eb;
        }

        .checkout-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        /* === CSS M·ªöI CHO MODAL === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #1e293b;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1e293b;
        }

        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* N√∫t trong Modal (ƒë√£ c√≥ t·ª´ CSS g·ªëc, nh∆∞ng th√™m cho ch·∫Øc) */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>

<div layout:fragment="content" class="cart-container">
    <div class="cart-header">
        <h1 class="cart-title">Gi·ªè h√†ng c·ªßa t√¥i</h1>
    </div>

    <div id="cartEmpty" style="display: none;">
        <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            <h3 class="cart-empty-title">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h3>
            <p class="cart-empty-text">H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè ƒë·ªÉ ti·∫øp t·ª•c mua s·∫Øm.</p>
            <a href="/catalog" class="btn btn-primary">
                Mua s·∫Øm ngay
            </a>
        </div>
    </div>

    <div id="cartContent" class="cart-content" style="display: none;">
        <div id="cartItems" class="cart-items">
        </div>

        <div class="cart-summary">
            <h3 class="summary-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
            <div class="summary-row">
                <span>T·∫°m t√≠nh:</span>
                <span id="subtotal">0 ‚Ç´</span>
            </div>
            <div class="summary-row">
                <span>Gi·∫£m gi√°:</span>
                <span>0 ‚Ç´</span>
            </div>
            <div class="summary-total">
                <span class="summary-total-label">T·ªïng c·ªông:</span>
                <span id="total" class="summary-total-value">0 ‚Ç´</span>
            </div>
            <button id="checkoutBtn" class="checkout-btn">
                Ti·∫øn h√†nh thanh to√°n
            </button>
        </div>
    </div>

    <div id="checkoutModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Th√¥ng tin giao h√†ng</h2>
                <button class="modal-close" onclick="closeCheckoutModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="shippingAddress">ƒê·ªãa ch·ªâ giao h√†ng *</label>
                        <textarea
                                id="shippingAddress"
                                name="shippingAddress"
                                rows="3"
                                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng ƒë·∫ßy ƒë·ªß..."
                                required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                        <select id="paymentMethod" name="paymentMethod" class="form-select">
                            <option value="COD">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
                            <option value="BANK_TRANSFER">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                            <option value="VNPAY">VNPay</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCheckoutModal()">
                            H·ªßy
                        </button>
                        <button type="submit" class="btn btn-primary" id="confirmCheckoutBtn">
                            X√°c nh·∫≠n ƒë·∫∑t h√†ng
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script>
        // === C√ÅC H√ÄM C≈® (Render gi·ªè h√†ng) ===

        function renderCart() {
            if (!window.CartManager) {
                console.error('L·ªñI: CartManager kh√¥ng ƒë∆∞·ª£c n·∫°p!');
                return;
            }

            // 1. L·∫•y c√°c ph·∫ßn t·ª≠ HTML
            const cartEmptyEl = document.getElementById('cartEmpty');
            const cartContentEl = document.getElementById('cartContent');
            const cartItemsContainer = document.getElementById('cartItems');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            const checkoutBtn = document.getElementById('checkoutBtn');

            // 2. L·∫•y gi·ªè h√†ng V√Ä L·ªåC D·ªÆ LI·ªÜU R√ÅC
            const cart = window.CartManager.getCart().filter(item =>
                item && (item.bookId !== null && item.bookId !== undefined)
            );

            // 3. Ki·ªÉm tra gi·ªè h√†ng tr·ªëng (sau khi ƒë√£ l·ªçc)
            if (!cart || cart.length === 0) {
                cartEmptyEl.style.display = 'block';
                cartContentEl.style.display = 'none';
                window.CartManager.clearCart(); // D·ªçn d·∫πp n·∫øu gi·ªè h√†ng r·ªóng
                return;
            }

            // 4. N·∫øu c√≥ h√†ng, hi·ªÉn th·ªã n·ªôi dung
            cartEmptyEl.style.display = 'none';
            cartContentEl.style.display = 'grid';

            let itemsHtml = '';
            let subtotal = 0;

            // 5. Render t·ª´ng s·∫£n ph·∫©m
            cart.forEach(item => {
                const bookId = item.bookId;
                const title = item.title || 'S√°ch kh√¥ng t√™n';
                const image = item.image || null;
                const itemPrice = parseFloat(item.price) || 0;
                const itemQuantity = parseInt(item.quantity) || 1;

                const itemTotal = itemPrice * itemQuantity;
                subtotal += itemTotal;

                itemsHtml += `
                <div class="cart-item">
                    <div class="cart-item-image">
                        ${image ? `<img src="${image}" alt="${title}">` : 'üìñ'}
                    </div>
                    <div class="cart-item-details">
                        <h3 class="cart-item-title">${title}</h3>
                        <p class="cart-item-price">${formatPrice(itemPrice)}</p>

                        <div class="cart-item-actions">
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="handleUpdateQuantity('${bookId}', ${itemQuantity - 1})">-</button>
                                <input type="number" class="quantity-input" value="${itemQuantity}" min="1"
                                       onchange="handleUpdateQuantity('${bookId}', parseInt(this.value))">
                                <button class="quantity-btn" onclick="handleUpdateQuantity('${bookId}', ${itemQuantity + 1})">+</button>
                            </div>
                            <button class="remove-btn" onclick="handleRemoveItem('${bookId}')">
                                X√≥a
                            </button>
                        </div>
                    </div>
                </div>
                `;
            });

            // 6. C·∫≠p nh·∫≠t DOM
            cartItemsContainer.innerHTML = itemsHtml;
            subtotalEl.textContent = formatPrice(subtotal);
            totalEl.textContent = formatPrice(subtotal);
            checkoutBtn.disabled = false;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price || 0);
        }

        function handleRemoveItem(bookId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                window.CartManager.removeFromCart(bookId);
                renderCart();
                if (window.CartManager.updateCartBadge) {
                    window.CartManager.updateCartBadge();
                }
            }
        }

        function handleUpdateQuantity(bookId, newQuantity) {
            if (newQuantity < 1) {
                handleRemoveItem(bookId);
                return;
            }
            window.CartManager.updateQuantity(bookId, newQuantity);
            renderCart();
            if (window.CartManager.updateCartBadge) {
                window.CartManager.updateCartBadge();
            }
        }

        // === C√ÅC H√ÄM CHECKOUT ===

        function openCheckoutModal() {
            console.log('M·ªü modal thanh to√°n...');

            const modal = document.getElementById('checkoutModal');
            const cart = window.CartManager.getCart();

            if (!cart || cart.length === 0) {
                alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
                return;
            }

            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c thanh to√°n!');
                window.location.href = '/login';
                return;
            }

            modal.style.display = 'flex';

            // Load ƒë·ªãa ch·ªâ ƒë√£ l∆∞u (n·∫øu c√≥)
            const savedAddress = localStorage.getItem('lastShippingAddress');
            if (savedAddress) {
                document.getElementById('shippingAddress').value = savedAddress;
            }
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        async function handleCheckout(event) {
            event.preventDefault();

            const confirmBtn = document.getElementById('confirmCheckoutBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="loading-spinner"></span>ƒêang x·ª≠ l√Ω...';

            try {
                // 1. L·∫•y d·ªØ li·ªáu t·ª´ form v√† gi·ªè h√†ng
                const shippingAddress = document.getElementById('shippingAddress').value.trim();
                const paymentMethod = document.getElementById('paymentMethod').value;
                const cart = window.CartManager.getCart();

                if (!shippingAddress) {
                    throw new Error('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!');
                }

                if (!cart || cart.length === 0) {
                    throw new Error('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
                }

                // 2. Chuy·ªÉn ƒë·ªïi cart items sang format API
                const items = cart.map(item => ({
                    bookId: parseInt(item.bookId),
                    quantity: parseInt(item.quantity) || 1
                })).filter(item => item.bookId && item.quantity > 0);

                if (items.length === 0) {
                    throw new Error('Kh√¥ng c√≥ s·∫£n ph·∫©m h·ª£p l·ªá trong gi·ªè h√†ng!');
                }

                // 3. T·∫°o request body
                const requestBody = {
                    items: items,
                    shippingAddress: shippingAddress,
                    paymentMethod: paymentMethod
                };

                console.log('ƒêang t·∫°o ƒë∆°n h√†ng:', requestBody);

                // 4. G·ªçi API t·∫°o ƒë∆°n h√†ng - S·ª¨A L·∫†I PH·∫¶N N√ÄY
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'C√≥ l·ªói x·∫£y ra khi t·∫°o ƒë∆°n h√†ng';

                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o:', result);

                // 5. L∆∞u ƒë·ªãa ch·ªâ ƒë·ªÉ d√πng l·∫ßn sau
                localStorage.setItem('lastShippingAddress', shippingAddress);

                // 6. X√≥a gi·ªè h√†ng
                window.CartManager.clearCart();

                // 7. ƒê√≥ng modal
                closeCheckoutModal();

                // 8. Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng v√† redirect
                alert('ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: #' + (result.data?.id || result.data?.orderCode || 'N/A'));
                window.location.href = '/orders';

            } catch (error) {
                console.error('L·ªói khi ƒë·∫∑t h√†ng:', error);
                alert('L·ªói: ' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        // === KH·ªûI CH·∫†Y - ƒê√É X√ìA setupDebugTools ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Trang gi·ªè h√†ng ƒë√£ load, ƒëang render...');
            renderCart();
            // ƒê√É X√ìA: setupDebugTools(); // D√≤ng n√†y g√¢y l·ªói

            // G·∫Øn event listener cho n√∫t checkout
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', openCheckoutModal);
            }

            // G·∫Øn event listener cho form checkout
            const checkoutForm = document.getElementById('checkoutForm');
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', handleCheckout);
            }

            // ƒê√≥ng modal khi click b√™n ngo√†i
            const modal = document.getElementById('checkoutModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeCheckoutModal();
                    }
                });
            }

            // C·∫≠p nh·∫≠t badge
            if (window.CartManager && window.CartManager.updateCartBadge) {
                window.CartManager.updateCartBadge();
            }
        });
    </script>
</th:block>

</body>
</html>